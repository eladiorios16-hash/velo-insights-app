<script>
    // --- VARIABLES GLOBALES ---
    let PRO_STATS = {}; 

    const weightInput = document.getElementById('weight');
    const wattsInput = document.getElementById('watts');
    const rivalSelect = document.getElementById('rival-selector');
    const analysisContent = document.getElementById('analysis-content');
    const wkgDisplay = document.getElementById('wkg-display');
    const climbSlider = document.getElementById('climb-slider');
    const climbTimeDisplay = document.getElementById('climb-time-display');
    const climbWkgDisplay = document.getElementById('climb-wkg-display');
    const userClimbPrediction = document.getElementById('user-climb-prediction');

    let radarChart = null;
    let climbChart = null;
    let climbDebounce = null;

    // --- 1. CARGAR DATOS DESDE TU API EN RAILWAY ---
    async function loadProData() {
        try {
            // Usamos ruta relativa para que funcione en Railway
            const response = await fetch('/api/ranking');
            if (!response.ok) throw new Error('Error en API');
            
            const data = await response.json();
            rivalSelect.innerHTML = ''; // Limpiar selector
            
            const colors = ['#eab308', '#22d3ee', '#a855f7', '#ec4899', '#10b981'];
            
            // Procesamos el Top 5 del Ranking para el comparador
            data.slice(0, 5).forEach((rider, index) => {
                let statsObj;
                try {
                    // Manejamos si el profile viene como String o ya como Objeto
                    statsObj = typeof rider.profile === 'string' ? JSON.parse(rider.profile).stats : rider.profile.stats;
                } catch(e) {
                    statsObj = { climb: 85, sprint: 75, tt: 80 };
                }
                
                // Mapeamos los datos de la DB al radar (Escalada, Sprint, TT, Resistencia, Técnica)
                const mnt = parseInt(statsObj.climb || 80);
                const spr = parseInt(statsObj.sprint || 75);
                const tt = parseInt(statsObj.tt || 80);
                const res = Math.floor((mnt + tt) / 2); // Resistencia estimada
                const tec = 90; // Valor técnico base WorldTour

                const key = `rider_${rider.id}`;
                PRO_STATS[key] = {
                    name: rider.name,
                    team: rider.team,
                    stats: [mnt, spr, tt, res, tec],
                    color: colors[index % colors.length],
                    bg: colors[index % colors.length] + '33'
                };

                const option = document.createElement('option');
                option.value = key;
                option.text = `${rider.name} (${rider.team})`;
                rivalSelect.appendChild(option);
            });

            updateAll();

        } catch (error) {
            console.error("Fallo de conexión con la DB:", error);
            rivalSelect.innerHTML = '<option>Error: Usando datos locales</option>';
            // Fallback en caso de que la API falle
            PRO_STATS['fallback'] = { name: 'Tadej Pogačar', stats: [99, 85, 92, 95, 98], color: '#eab308', bg: '#eab30833' };
            updateAll();
        }
    }

    // --- 2. LÓGICA DE CÁLCULO Y GRÁFICOS ---
    function getUserStats() {
        const w = parseFloat(wattsInput.value) || 0;
        const kg = parseFloat(weightInput.value) || 70;
        const wkg = w > 0 ? (w / kg) : 0;
        return { w, kg, wkg };
    }

    function updateCalculator() {
        const { w, wkg } = getUserStats();
        wkgDisplay.innerText = wkg.toFixed(2);
        
        // Guardamos en el navegador del usuario para que no tenga que rellenarlo siempre
        localStorage.setItem('velo_weight', weightInput.value);
        localStorage.setItem('velo_watts', wattsInput.value);

        const zones = [
            { n: 'Z1', name: 'Recuperación', range: `< ${Math.round(w*0.55)}`, color: 'text-zinc-500' },
            { n: 'Z2', name: 'Resistencia', range: `${Math.round(w*0.56)}-${Math.round(w*0.75)}`, color: 'text-cyan-400' },
            { n: 'Z3', name: 'Tempo', range: `${Math.round(w*0.76)}-${Math.round(w*0.90)}`, color: 'text-green-500' },
            { n: 'Z4', name: 'Umbral (FTP)', range: `${Math.round(w*0.91)}-${Math.round(w*1.05)}`, color: 'text-yellow-500' },
            { n: 'Z5', name: 'Capacidad VO2', range: `> ${Math.round(w*1.06)}`, color: 'text-pink-500' },
        ];

        document.getElementById('zones-table').innerHTML = zones.map(z => `
            <tr class="hover:bg-zinc-800 transition-colors">
                <td class="py-2.5 pl-4"><span class="font-black text-[10px] uppercase ${z.color}">${z.n}</span></td>
                <td class="py-2.5 text-[10px] uppercase font-bold text-zinc-400">${z.name}</td>
                <td class="py-2.5 font-bold text-white text-right pr-4">${z.range}w</td>
            </tr>
        `).join('');
    }

    function updateRadar() {
        if (typeof Chart === 'undefined') return;
        const skeleton = document.getElementById('radar-skeleton');
        if(skeleton) skeleton.style.display = 'none';

        const { wkg } = getUserStats();
        const rivalKey = rivalSelect.value || Object.keys(PRO_STATS)[0];
        const rival = PRO_STATS[rivalKey];
        if (!rival) return;

        // Calculamos tu puntuación relativa al WorldTour (6.5 W/kg = 100%)
        const userScore = Math.min(95, (wkg / 6.5) * 100);

        const data = {
            labels: ['Escalada', 'Sprint', 'Resistencia', 'Recuperación', 'Técnica'],
            datasets: [{
                label: 'Tú',
                data: [userScore, userScore * 0.8, userScore * 0.9, userScore * 0.7, 50],
                backgroundColor: 'rgba(34, 211, 238, 0.1)',
                borderColor: '#22d3ee',
                borderWidth: 2,
                pointRadius: 0
            }, {
                label: rival.name,
                data: rival.stats,
                backgroundColor: rival.bg,
                borderColor: rival.color,
                borderWidth: 2,
                pointRadius: 0
            }]
        };

        if(radarChart) radarChart.destroy();
        radarChart = new Chart(document.getElementById('radarChart'), {
            type: 'radar',
            data: data,
            options: {
                scales: { r: { 
                    angleLines: { color: 'rgba(255, 255, 255, 0.05)' },
                    grid: { color: 'rgba(255, 255, 255, 0.05)' },
                    pointLabels: { color: '#71717a', font: { size: 9, weight: 'bold' } },
                    ticks: { display: false },
                    suggestedMin: 0, suggestedMax: 100
                }},
                plugins: { legend: { labels: { color: 'white', font: { size: 10 }, boxWidth: 10 } } },
                maintainAspectRatio: false
            }
        });

        const gap = wkg > 0 ? ((wkg / 6.5) * 100).toFixed(0) : 0;
        analysisContent.innerHTML = `
            <div class="flex justify-between items-end mb-2">
                <span class="text-[9px] font-black uppercase text-zinc-500">Nivel WorldTour</span>
                <span class="text-lg font-mono font-bold text-white">${gap}%</span>
            </div>
            <div class="w-full bg-zinc-900 rounded-full h-1.5 mb-2">
                <div class="bg-gradient-to-r from-cyan-500 to-pink-500 h-1.5 rounded-full" style="width: ${Math.min(100, gap)}%"></div>
            </div>
            <p class="text-[9px] text-zinc-400 italic">Estás rindiendo al <span class="text-white font-bold">${gap}%</span> del potencial de ${rival.name}.</p>
        `;
    }

    function updateClimbSim() {
        if (climbDebounce) clearTimeout(climbDebounce);
        climbDebounce = setTimeout(() => {
            if (typeof Chart === 'undefined') return;
            const skeleton = document.getElementById('climb-skeleton');
            if(skeleton) skeleton.style.display = 'none';

            const minutes = parseInt(climbSlider.value);
            climbTimeDisplay.innerHTML = `${minutes}<span class="text-sm text-zinc-600 not-italic ml-1">min</span>`;
            const requiredWkg = (235.7 / minutes).toFixed(2);
            climbWkgDisplay.innerText = `${requiredWkg} W/kg`;

            const { wkg } = getUserStats();
            let userTimeEstimated = wkg > 0 ? (235.7 / wkg).toFixed(1) : 0;

            if (wkg > 0) {
                userClimbPrediction.classList.remove('hidden');
                userClimbPrediction.innerHTML = `Con <b>${wkg.toFixed(2)} W/kg</b>, tu tiempo estimado sería de <b class="text-white">${Math.floor(userTimeEstimated)} minutos</b>.`;
            }

            const data = {
                labels: ['M. Pantani (Rec)', 'Tu Objetivo', 'Tu Actual'],
                datasets: [{
                    data: [36.8, minutes, userTimeEstimated || 90],
                    backgroundColor: ['#eab308', '#ffffff', '#22d3ee'],
                    borderRadius: 4
                }]
            };

            if(climbChart) climbChart.destroy();
            climbChart = new Chart(document.getElementById('climbChart'), {
                type: 'bar',
                data: data,
                options: {
                    indexAxis: 'y',
                    scales: {
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#71717a' } },
                        y: { grid: { display: false }, ticks: { color: '#fff', font: { weight: 'bold' } } }
                    },
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false
                }
            });
        }, 300);
    }

    function updateAll() {
        updateCalculator();
        updateRadar();
        updateClimbSim();
    }

    // --- EVENTOS ---
    weightInput.addEventListener('input', updateAll);
    wattsInput.addEventListener('input', updateAll);
    rivalSelect.addEventListener('change', updateRadar);
    climbSlider.addEventListener('input', updateClimbSim);

    window.onload = () => {
        const savedW = localStorage.getItem('velo_watts');
        const savedKg = localStorage.getItem('velo_weight');
        if(savedW) wattsInput.value = savedW;
        if(savedKg) weightInput.value = savedKg;
        loadProData();
    };
</script>
