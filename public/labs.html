<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/svg+xml" href="assets/logo-icon.svg">
    
    <title>VELO INSIGHTS | Performance Lab</title>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="assets/icon-192.png">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('✅ App registrada', reg.scope))
                    .catch(err => console.log('❌ Error registro App', err));
            });
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="assets/main.css">

    <style>
        body { -webkit-tap-highlight-color: transparent; }
        @keyframes skeleton-pulse {
            0% { background-color: #09090b; }
            50% { background-color: #18181b; }
            100% { background-color: #09090b; }
        }
        .chart-skeleton {
            position: absolute; inset: 0; animation: skeleton-pulse 1.5s infinite ease-in-out;
            border-radius: 1rem; z-index: 5; display: flex; align-items: center; justify-content: center;
        }
        .chart-skeleton::after {
            content: "INICIALIZANDO GRÁFICOS..."; font-size: 9px; font-weight: 900; color: #3f3f46; letter-spacing: 0.2em;
        }
        
        /* GLASSMORPHISM AVANZADO */
        .glass { 
            background: rgba(10, 10, 12, 0.7); 
            backdrop-filter: blur(20px); 
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }
        
        /* Custom Sliders: Input TYPE=RANGE */
        input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; margin-top: 10px; }
        input[type=range]:focus { outline: none; }
        
        /* Pista del slider */
        input[type=range]::-webkit-slider-runnable-track { 
            width: 100%; height: 6px; cursor: pointer; border-radius: 3px; 
            background: rgba(255,255,255,0.1); 
        }
        /* Color dinámico para la pista (se maneja vía JS) */
        .slider-cyan::-webkit-slider-runnable-track { background: linear-gradient(to right, #22d3ee var(--val), rgba(255,255,255,0.1) var(--val)); }
        .slider-pink::-webkit-slider-runnable-track { background: linear-gradient(to right, #ec4899 var(--val), rgba(255,255,255,0.1) var(--val)); }
        .slider-yellow::-webkit-slider-runnable-track { background: linear-gradient(to right, #eab308 var(--val), rgba(255,255,255,0.1) var(--val)); }

        /* Botón del slider */
        input[type=range]::-webkit-slider-thumb { 
            -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; 
            background: #fff; margin-top: -7px; cursor: pointer; transition: transform 0.1s, box-shadow 0.2s; 
        }
        .slider-cyan::-webkit-slider-thumb { box-shadow: 0 0 15px rgba(34, 211, 238, 0.8); border: 2px solid #22d3ee; }
        .slider-pink::-webkit-slider-thumb { box-shadow: 0 0 15px rgba(236, 72, 153, 0.8); border: 2px solid #ec4899; }
        .slider-yellow::-webkit-slider-thumb { box-shadow: 0 0 15px rgba(234, 179, 8, 0.8); border: 2px solid #eab308; }
        
        input[type=range]::-webkit-slider-thumb:active { transform: scale(1.3); }

        .climb-profile-bg {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; z-index: 0; 
            opacity: 0.5; 
            mask-image: linear-gradient(to top, black 20%, transparent 90%);
            -webkit-mask-image: linear-gradient(to top, black 20%, transparent 90%);
            transition: all 0.5s ease-in-out;
        }

        /* Ocultar input number arrows */
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    </style>
</head>

<body class="bg-[#050505] antialiased overflow-x-hidden selection:bg-cyan-500/30 selection:text-cyan-200">

    <header class="pt-32 md:pt-48 pb-8 md:pb-12 px-4 md:px-6 max-w-7xl mx-auto text-center md:text-left">
        <h1 class="text-4xl md:text-6xl font-heading text-white italic uppercase tracking-tighter mb-3 md:mb-4 leading-none">Performance Lab <span class="text-cyan-500 animate-pulse">///</span></h1>
        <p class="text-zinc-500 max-w-lg font-medium text-xs md:text-sm mx-auto md:mx-0">Simulador telemétrico en tiempo real. Ajusta tus parámetros para descubrir tu nivel respecto al pelotón WorldTour.</p>
    </header>

    <main class="max-w-7xl mx-auto px-4 md:px-6 grid grid-cols-1 lg:grid-cols-2 gap-6 md:gap-8 pb-20">
        
        <section class="glass p-5 md:p-8 rounded-3xl relative overflow-hidden flex flex-col justify-between border-t border-zinc-700/50" id="telemetry-card">
            <div id="rank-glow" class="absolute -top-24 -right-24 w-64 h-64 rounded-full blur-[100px] pointer-events-none transition-colors duration-700"></div>

            <h3 class="text-lg md:text-xl font-heading text-white italic uppercase mb-8 flex items-center gap-3 relative z-10">
                <span class="w-1.5 h-6 md:w-2 md:h-8 bg-cyan-500 block skew-x-[-10deg] shadow-[0_0_15px_rgba(34,211,238,0.5)]"></span>
                Telemetría del ciclista
            </h3>
            
            <div class="space-y-8 relative z-10 mb-8">
                <div class="bg-black/40 p-4 rounded-2xl border border-zinc-800 hover:border-cyan-500/30 transition-colors">
                    <div class="flex justify-between items-end mb-2">
                        <label class="block text-[10px] font-black uppercase text-zinc-500 tracking-wider">Masa Corporal</label>
                        <div class="flex items-baseline gap-1">
                            <input type="number" id="weight-num" value="70" class="w-12 bg-transparent text-white font-mono text-xl text-right outline-none">
                            <span class="text-[10px] text-zinc-500 font-bold">KG</span>
                        </div>
                    </div>
                    <input type="range" id="weight" min="40" max="110" value="70" class="slider-cyan" style="--val: 42%;">
                </div>

                <div class="bg-black/40 p-4 rounded-2xl border border-zinc-800 hover:border-cyan-500/30 transition-colors">
                    <div class="flex justify-between items-end mb-2">
                        <label class="block text-[10px] font-black uppercase text-zinc-500 tracking-wider">Potencia Umbral (FTP)</label>
                        <div class="flex items-baseline gap-1">
                            <input type="number" id="watts-num" value="250" class="w-16 bg-transparent text-white font-mono text-xl text-right outline-none">
                            <span class="text-[10px] text-zinc-500 font-bold">W</span>
                        </div>
                    </div>
                    <input type="range" id="watts" min="100" max="500" value="250" class="slider-cyan" style="--val: 37%;">
                </div>
            </div>

            <div class="bg-zinc-950 rounded-2xl p-6 border border-zinc-800 flex justify-between items-center relative overflow-hidden group shadow-inner">
                <div class="absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full group-hover:translate-x-full transition-transform duration-1000"></div>
                <div>
                    <div class="flex items-center gap-2 mb-1">
                        <span id="rank-badge" class="text-xs font-black px-2 py-0.5 rounded uppercase tracking-widest text-black transition-all duration-300">Rango</span>
                        <p class="text-[9px] font-black uppercase text-zinc-500 tracking-widest">Rendimiento Relativo</p>
                    </div>
                    <p id="wkg-level-desc" class="text-xs text-zinc-400 font-bold mt-2 transition-colors duration-300 max-w-[200px]">Ajusta los controles</p>
                </div>
                <div class="text-right z-10 flex flex-col items-end">
                    <div class="flex items-baseline gap-1">
                        <p class="text-5xl md:text-6xl font-heading italic tracking-tighter transition-colors duration-300" id="wkg-display">0.00</p>
                        <p class="text-[10px] font-bold text-zinc-500 uppercase">W/kg</p>
                    </div>
                </div>
            </div>
        </section>

        <section class="glass p-5 md:p-8 rounded-3xl flex flex-col relative overflow-hidden border-t border-zinc-700/50">
            <div class="absolute -bottom-24 -left-24 w-64 h-64 bg-pink-500/10 rounded-full blur-[80px] pointer-events-none"></div>

            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4 relative z-10">
                <h3 class="text-lg md:text-xl font-heading text-white italic uppercase flex items-center gap-3">
                    <span class="w-1.5 h-6 md:w-2 md:h-8 bg-pink-500 block skew-x-[-10deg] shadow-[0_0_15px_rgba(236,72,153,0.5)]"></span>
                    Versus Pro
                </h3>
                <div class="relative group w-full md:w-auto">
                    <select id="rival-selector" class="w-full md:w-auto bg-black border border-zinc-700 text-white text-[10px] font-black uppercase rounded-lg px-4 py-2.5 outline-none focus:border-pink-500 appearance-none cursor-pointer pr-8 shadow-lg transition-colors hover:bg-zinc-900"></select>
                    <div class="absolute right-3 top-2.5 pointer-events-none text-zinc-500">▼</div>
                </div>
            </div>

            <div class="relative h-64 w-full mb-6 z-10 bg-black/20 rounded-2xl border border-white/5 p-4">
                <div id="radar-skeleton" class="chart-skeleton"></div>
                <canvas id="radarChart"></canvas>
            </div>
            
            <div id="analysis-content" class="mt-auto p-5 bg-black/60 rounded-xl border border-zinc-800 z-10 backdrop-blur-md min-h-[90px] flex flex-col justify-center">
                <p class="text-[10px] text-zinc-500 text-center animate-pulse tracking-widest uppercase">Actualizando telemetría...</p>
            </div>
        </section>

        <section class="glass p-5 md:p-8 rounded-3xl col-span-1 lg:col-span-2 relative overflow-hidden border-t border-zinc-700/50">
            <div id="climb-profile-container" class="climb-profile-bg"></div>

            <div class="relative z-10">
                <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10 gap-4">
                    <h3 class="text-lg md:text-xl font-heading text-white italic uppercase flex items-center gap-3 drop-shadow-md">
                        <span class="w-1.5 h-6 md:w-2 md:h-8 bg-yellow-500 block skew-x-[-10deg] shadow-[0_0_15px_rgba(234,179,8,0.5)]"></span>
                        Simulador de Ascenso Mítico
                    </h3>
                    
                    <div class="relative group w-full md:w-auto">
                        <select id="climb-select" class="w-full md:w-64 bg-black border border-zinc-700 text-white text-xs font-bold uppercase rounded-xl px-4 py-2.5 outline-none focus:border-yellow-500 appearance-none cursor-pointer tracking-wide shadow-lg hover:bg-zinc-900 transition-colors">
                            <option value="alpe">Alpe d'Huez (13.8km @ 8.1%)</option>
                            <option value="angliru">L'Angliru (12.5km @ 10.1%)</option>
                            <option value="tourmalet">Tourmalet (19.0km @ 7.4%)</option>
                            <option value="mortirolo">Mortirolo (11.8km @ 10.9%)</option>
                            <option value="stelvio">Stelvio (24.3km @ 7.4%)</option>
                        </select>
                        <div class="absolute right-3 top-3 pointer-events-none text-zinc-500">▼</div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-10 items-center">
                    <div>
                        <div class="mb-10 bg-black/60 p-6 rounded-2xl border border-zinc-800 backdrop-blur-md">
                            <label class="flex justify-between items-end text-[9px] font-black uppercase text-zinc-400 mb-5">
                                <span>Tiempo Objetivo</span>
                                <span class="text-yellow-500 text-2xl font-mono leading-none drop-shadow-[0_0_10px_rgba(234,179,8,0.3)]" id="slider-val-display">60m</span>
                            </label>
                            <input type="range" id="climb-slider" min="30" max="120" value="60" class="slider-yellow w-full" style="--val: 33%;">
                            <div class="flex justify-between text-[8px] text-zinc-600 font-mono mt-4 uppercase font-bold">
                                <span>Récord Pro</span>
                                <span>Cicloturista</span>
                            </div>
                        </div>

                        <div class="flex items-center justify-between p-6 bg-gradient-to-r from-black to-zinc-950 rounded-2xl border border-zinc-800 shadow-2xl relative overflow-hidden">
                            <div class="absolute -right-10 -bottom-10 w-32 h-32 bg-yellow-500/10 rounded-full blur-2xl"></div>
                            
                            <div>
                                <p class="text-[9px] text-zinc-500 uppercase font-black mb-1">Récord Absoluto</p>
                                <p class="text-xl font-heading italic text-white" id="record-holder">Pantani '97</p>
                                <p class="text-xs font-mono text-zinc-400" id="record-time">36m 50s</p>
                            </div>
                            <div class="text-right z-10 border-l border-zinc-800 pl-5">
                                <p class="text-[9px] text-zinc-500 uppercase font-black mb-1">Tu Potencia Requerida</p>
                                <p class="text-4xl font-mono text-yellow-500 font-black drop-shadow-[0_0_15px_rgba(234,179,8,0.4)]" id="climb-wkg-display">--</p>
                                <p class="text-[10px] font-bold text-zinc-500 mt-1 transition-colors bg-black px-2 py-1 rounded inline-block" id="wkg-diff-display">--</p>
                            </div>
                        </div>
                    </div>

                    <div class="relative h-72 w-full bg-black/40 p-5 rounded-2xl border border-white/5 backdrop-blur-sm">
                        <div id="climb-skeleton" class="chart-skeleton"></div>
                        <canvas id="climbChart"></canvas>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <script src="layout.js"></script>
    <script>
        const CLIMBS = {
            'alpe': { name: "Alpe d'Huez", km: 13.8, grad: 8.1, record: 37.6, holder: "M. Pantani '97", factor: 248, color: '#eab308', shape: "M0,100 L0,80 Q20,60 40,70 T80,40 L100,20 L100,100 Z" },
            'angliru': { name: "L'Angliru", km: 12.5, grad: 10.1, record: 41.9, holder: "J. Vingegaard '23", factor: 289, color: '#ef4444', shape: "M0,100 L0,90 Q30,85 50,60 C60,40 70,30 100,5 L100,100 Z" },
            'tourmalet': { name: "Tourmalet", km: 19.0, grad: 7.4, record: 45.2, holder: "J. Vingegaard '23", factor: 293, color: '#3b82f6', shape: "M0,100 L0,85 L100,15 L100,100 Z" },
            'mortirolo': { name: "Mortirolo", km: 11.8, grad: 10.9, record: 41.3, holder: "M. Pantani '94", factor: 276, color: '#a855f7', shape: "M0,100 L0,90 L100,10 L100,100 Z" },
            'stelvio': { name: "Stelvio", km: 24.3, grad: 7.4, record: 60.5, holder: "R. Dennis '20", factor: 369, color: '#10b981', shape: "M0,100 L0,90 Q50,70 100,30 L100,100 Z" }
        };

        const PRO_STATS = {
            'pogacar': { name: 'Tadej Pogačar', team: 'UAE', stats: [99, 88, 95, 99, 97], color: '#eab308', bg: 'rgba(234, 179, 8, 0.2)' },
            'vingegaard': { name: 'Jonas Vingegaard', team: 'Visma', stats: [100, 68, 93, 98, 95], color: '#fbbf24', bg: 'rgba(251, 191, 36, 0.2)' },
            'evenepoel': { name: 'Remco Evenepoel', team: 'Soudal', stats: [92, 80, 100, 93, 90], color: '#a855f7', bg: 'rgba(168, 85, 247, 0.2)' },
            'van_aert': { name: 'Wout van Aert', team: 'Visma', stats: [82, 92, 96, 96, 98], color: '#22d3ee', bg: 'rgba(34, 211, 238, 0.2)' },
            'roglic': { name: 'Primož Roglič', team: 'Red Bull', stats: [94, 82, 91, 94, 92], color: '#ec4899', bg: 'rgba(236, 72, 153, 0.2)' }
        };

        // DOM Elements
        const weightSlider = document.getElementById('weight');
        const weightNum = document.getElementById('weight-num');
        const wattsSlider = document.getElementById('watts');
        const wattsNum = document.getElementById('watts-num');
        
        const rivalSelect = document.getElementById('rival-selector');
        const wkgDisplay = document.getElementById('wkg-display');
        const wkgLevelDesc = document.getElementById('wkg-level-desc');
        const rankBadge = document.getElementById('rank-badge');
        const rankGlow = document.getElementById('rank-glow');
        const analysisContent = document.getElementById('analysis-content');
        
        const climbSelect = document.getElementById('climb-select');
        const climbSlider = document.getElementById('climb-slider');
        const sliderValDisplay = document.getElementById('slider-val-display');
        const recordHolderDisplay = document.getElementById('record-holder');
        const recordTimeDisplay = document.getElementById('record-time');
        const climbWkgDisplay = document.getElementById('climb-wkg-display');
        const wkgDiffDisplay = document.getElementById('wkg-diff-display');
        const climbBgContainer = document.getElementById('climb-profile-container');

        let radarChart = null, climbChart = null;
        let climbDebounceTimer;
        let radarDebounceTimer; // <-- Nuevo timer para el retraso del gráfico Radar

        // Sync inputs and sliders
        function syncInputs(slider, numBox) {
            slider.addEventListener('input', () => {
                numBox.value = slider.value;
                updateSliderStyle(slider);
                updateAll();
            });
            numBox.addEventListener('input', () => {
                let val = parseInt(numBox.value) || slider.min;
                if(val < slider.min) val = slider.min;
                if(val > slider.max) val = slider.max;
                slider.value = val;
                updateSliderStyle(slider);
                updateAll();
            });
        }

        function updateSliderStyle(slider) {
            const percent = ((slider.value - slider.min) / (slider.max - slider.min)) * 100;
            slider.style.setProperty('--val', `${percent}%`);
        }

        function init() {
            rivalSelect.innerHTML = Object.entries(PRO_STATS).map(([k,v]) => `<option value="${k}">${v.name} (${v.team})</option>`).join('');
            
            if(localStorage.getItem('velo_weight')) {
                weightSlider.value = localStorage.getItem('velo_weight');
                weightNum.value = localStorage.getItem('velo_weight');
            }
            if(localStorage.getItem('velo_watts')) {
                wattsSlider.value = localStorage.getItem('velo_watts');
                wattsNum.value = localStorage.getItem('velo_watts');
            }
            
            syncInputs(weightSlider, weightNum);
            syncInputs(wattsSlider, wattsNum);
            updateSliderStyle(weightSlider);
            updateSliderStyle(wattsSlider);
            updateSliderStyle(climbSlider);
            
            updateAll();
            updateClimbBackground();
        }

        function updateAll() {
            const w = parseFloat(wattsSlider.value) || 0;
            const kg = parseFloat(weightSlider.value) || 0;
            const wkg = (w > 0 && kg > 0) ? (w / kg) : 0;
            
            wkgDisplay.innerText = wkg > 0 ? wkg.toFixed(2) : '0.00';
            
            let levelTxt = "Ingresa datos";
            let rankClass = "bg-zinc-700 text-zinc-400";
            let colorHex = "rgba(113, 113, 122, 0.2)"; 
            let shadowClass = "";
            let colorClass = "text-zinc-500";
            let rankLvl = "—";

            if (wkg > 0) {
                if (wkg < 2.5) { 
                    rankLvl = "D"; levelTxt = "Principiante. Toca sumar kilómetros."; 
                    rankClass = "bg-zinc-700 text-zinc-300"; colorClass = "text-zinc-400"; colorHex = "rgba(161, 161, 170, 0.2)";
                }
                else if (wkg < 3.5) { 
                    rankLvl = "C"; levelTxt = "Cicloturista en progresión."; 
                    rankClass = "bg-cyan-500 text-black"; colorClass = "text-cyan-400"; shadowClass = "drop-shadow-[0_0_15px_rgba(34,211,238,0.5)]"; colorHex = "rgba(34, 211, 238, 0.2)";
                }
                else if (wkg < 4.5) { 
                    rankLvl = "B"; levelTxt = "Nivel Amateur. Fuerte en grupetas."; 
                    rankClass = "bg-green-500 text-black"; colorClass = "text-green-400"; shadowClass = "drop-shadow-[0_0_15px_rgba(74,222,128,0.5)]"; colorHex = "rgba(74, 222, 128, 0.2)";
                }
                else if (wkg < 5.5) { 
                    rankLvl = "A"; levelTxt = "Élite Nacional. Listo para competir."; 
                    rankClass = "bg-yellow-400 text-black"; colorClass = "text-yellow-400"; shadowClass = "drop-shadow-[0_0_15px_rgba(250,204,21,0.5)]"; colorHex = "rgba(250, 204, 21, 0.2)";
                }
                else if (wkg < 6.2) { 
                    rankLvl = "S"; levelTxt = "Pro Continental. Puedes ganarte la vida con esto."; 
                    rankClass = "bg-orange-500 text-black"; colorClass = "text-orange-400"; shadowClass = "drop-shadow-[0_0_15px_rgba(249,115,22,0.5)]"; colorHex = "rgba(249, 115, 22, 0.2)";
                }
                else { 
                    rankLvl = "S+"; levelTxt = "Alien (World Tour). Prepara el Tour."; 
                    rankClass = "bg-pink-500 text-white animate-pulse"; colorClass = "text-pink-500"; shadowClass = "drop-shadow-[0_0_20px_rgba(236,72,153,0.8)]"; colorHex = "rgba(236, 72, 153, 0.3)";
                }
            }
            
            wkgLevelDesc.innerText = levelTxt;
            wkgLevelDesc.className = `text-xs font-bold transition-colors duration-300 ${colorClass}`;
            
            rankBadge.innerText = `RANGO ${rankLvl}`;
            rankBadge.className = `text-[10px] font-black px-2 py-0.5 rounded uppercase tracking-widest transition-all duration-300 shadow-lg ${rankClass}`;
            
            rankGlow.style.backgroundColor = colorHex;
            wkgDisplay.className = `text-5xl md:text-6xl font-heading italic tracking-tighter transition-all duration-300 ${colorClass} ${shadowClass}`;

            localStorage.setItem('velo_weight', weightSlider.value);
            localStorage.setItem('velo_watts', wattsSlider.value);

            // Muestra mensaje de "Calculando..." temporalmente
            analysisContent.innerHTML = `<p class="text-[10px] text-zinc-500 text-center animate-pulse tracking-widest uppercase">Actualizando telemetría...</p>`;
            
            // Retraso de medio segundo antes de renderizar la gráfica (DEBOUNCE)
            clearTimeout(radarDebounceTimer);
            radarDebounceTimer = setTimeout(() => {
                renderRadar();
            }, 500);

            handleClimbSliderInput(); 
        }

        function updateClimbBackground() {
            const key = climbSelect.value;
            const c = CLIMBS[key];
            climbBgContainer.innerHTML = `<svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="none" class="w-full h-full"><defs><linearGradient id="grad-${key}" x1="0%" y1="0%" x2="0%" y2="100%"><stop offset="0%" style="stop-color:${c.color};stop-opacity:0.4" /><stop offset="100%" style="stop-color:${c.color};stop-opacity:0" /></linearGradient></defs><path d="${c.shape}" fill="url(#grad-${key})" /><path d="${c.shape.replace('L100,100 Z', '')}" fill="none" stroke="${c.color}" stroke-width="0.5" stroke-opacity="0.5" vector-effect="non-scaling-stroke" /></svg>`;
        }

        function renderRadar() {
            if (typeof Chart === 'undefined') return;
            document.getElementById('radar-skeleton').style.display = 'none';
            const rival = PRO_STATS[rivalSelect.value];
            const wkg = parseFloat(wkgDisplay.innerText);
            
            // Fórmula para escalar la gráfica del usuario (max 100 pts si llega a 6.6 w/kg)
            const userScore = wkg > 0 ? Math.min(98, (wkg / 6.6) * 100) : 0;
            const userData = userScore > 0 ? [userScore, userScore*0.7, userScore*0.8, userScore*0.9, userScore*0.75] : [10, 10, 10, 10, 10];

            if (radarChart) radarChart.destroy();
            
            Chart.defaults.color = '#71717a';
            Chart.defaults.font.family = 'monospace';

            radarChart = new Chart(document.getElementById('radarChart'), {
                type: 'radar',
                data: {
                    labels: ['Escalada', 'Sprint', 'Crono', 'Resistencia', 'Técnica'],
                    datasets: [
                        { label: 'Tú', data: userData, borderColor: '#22d3ee', backgroundColor: 'rgba(34, 211, 238, 0.3)', borderWidth: 2, pointRadius: 4, pointBackgroundColor: '#fff' },
                        { label: rival.name, data: rival.stats, borderColor: rival.color, backgroundColor: 'transparent', borderWidth: 2, pointRadius: 0, borderDash: [4, 4] }
                    ]
                },
                options: { 
                    maintainAspectRatio: false, 
                    scales: { 
                        r: { 
                            suggestedMin: 0, suggestedMax: 100, ticks: { display: false }, 
                            grid: { color: 'rgba(255,255,255,0.05)', lineWidth: 1 }, 
                            angleLines: { color: 'rgba(255,255,255,0.1)' }, 
                            pointLabels: { color: '#a1a1aa', font: { size: 10, weight: 'bold' } } 
                        } 
                    }, 
                    plugins: { 
                        legend: { position: 'top', labels: { color: '#fff', boxWidth: 12, usePointStyle: true } },
                        tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleFont: {size: 10}, bodyFont: {size: 12} }
                    } 
                }
            });
            
            const gap = ((userScore / 100) * 100).toFixed(0);
            let message = "";
            if(gap < 40) message = `Te destrozaría en los primeros 5km. A entrenar.`;
            else if(gap < 70) message = `No podrías seguirle la rueda, pero al menos le verías de lejos.`;
            else if(gap < 90) message = `Nivel espectacular. Podrías aguantarle un buen rato.`;
            else message = `¿Eres tú, Tadej? Porque le darías pelea a ${rival.name}.`;

            // Actualiza el texto con animación de entrada
            analysisContent.innerHTML = `
                <div class="animate-fade-in">
                    <div class="flex justify-between items-end mb-3">
                        <span class="text-[10px] font-black uppercase text-zinc-400 tracking-widest">Afinidad vs ${rival.name.split(' ')[0]}</span>
                        <span class="text-xl font-heading italic text-cyan-400 leading-none">${gap}%</span>
                    </div>
                    <div class="w-full bg-black rounded-full h-2 mb-3 overflow-hidden border border-zinc-800">
                        <div class="bg-gradient-to-r from-zinc-700 via-cyan-500 to-cyan-300 h-full relative" style="width: ${gap}%; transition: width 0.5s ease-out;">
                            <div class="absolute right-0 top-0 bottom-0 w-4 bg-white/50 blur-sm"></div>
                        </div>
                    </div>
                    <p class="text-[10px] text-zinc-500 italic">${message}</p>
                </div>`;
        }

        function handleClimbSliderInput() {
            updateSliderStyle(climbSlider);
            const minutes = parseInt(climbSlider.value);
            sliderValDisplay.innerText = `${minutes}m`;
            
            const c = CLIMBS[climbSelect.value];
            const req = (c.factor / minutes).toFixed(2);
            
            climbWkgDisplay.innerText = `${req} W/kg`;
            climbWkgDisplay.style.color = c.color;
            climbWkgDisplay.style.textShadow = `0 0 15px ${c.color}60`;
            
            const userWkg = parseFloat(wkgDisplay.innerText);
            const userTime = userWkg > 0 ? (c.factor / userWkg).toFixed(1) : 0;
            
            if (userWkg <= 0) {
                wkgDiffDisplay.innerText = 'Define tu W/kg arriba ↑';
                wkgDiffDisplay.className = 'text-[9px] font-bold text-zinc-600 mt-1 uppercase tracking-widest';
            } else {
                const diff = (userWkg - req).toFixed(2);
                if (diff >= 0) {
                    wkgDiffDisplay.innerText = `Lo superas (+${diff} W/kg)`;
                    wkgDiffDisplay.className = 'text-[10px] font-bold text-green-400 mt-1 uppercase tracking-widest border border-green-500/30';
                } else {
                    wkgDiffDisplay.innerText = `Te faltan ${Math.abs(diff)} W/kg`;
                    wkgDiffDisplay.className = 'text-[10px] font-bold text-red-400 mt-1 uppercase tracking-widest border border-red-500/30';
                }
            }
            
            clearTimeout(climbDebounceTimer);
            climbDebounceTimer = setTimeout(() => renderClimb(minutes, userTime, c), 50);
        }

        function renderClimb(targetMins, userMins, climbObj) {
            if (typeof Chart === 'undefined') return;
            document.getElementById('climb-skeleton').style.display = 'none';
            
            recordHolderDisplay.innerText = climbObj.holder;
            recordTimeDisplay.innerText = `${climbObj.record.toFixed(1)} min`;

            if (climbChart) climbChart.destroy();
            climbChart = new Chart(document.getElementById('climbChart'), {
                type: 'bar',
                data: { 
                    labels: ['RÉCORD', 'TU OBJETIVO', 'TU TIEMPO REAL'], 
                    datasets: [{ 
                        data: [climbObj.record, targetMins, userMins > 0 ? userMins : null], 
                        backgroundColor: [climbObj.color, '#a1a1aa', '#22d3ee'], 
                        borderRadius: 4,
                        barThickness: 24 
                    }] 
                },
                options: { 
                    indexAxis: 'y', 
                    maintainAspectRatio: false, 
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) { return context.raw + ' min'; }
                            }
                        }
                    }, 
                    scales: { 
                        x: { grid: { color: 'rgba(255,255,255,0.05)' }, border: { display: false }, ticks: { color: '#71717a', font: { size: 10 } } }, 
                        y: { border: { display: false }, grid: { display: false }, ticks: { color: '#fff', font: { weight: 'bold', size: 10 } } } 
                    } 
                }
            });
        }

        climbSlider.addEventListener('input', handleClimbSliderInput);
        
        climbSelect.addEventListener('change', () => { 
            updateClimbBackground(); 
            handleClimbSliderInput(); 
        });

        rivalSelect.addEventListener('change', () => {
            renderRadar();
        });
        
        window.onload = init;
    </script>

    <div id="cookie-banner" class="hidden fixed bottom-4 left-4 right-4 md:left-auto md:right-8 md:bottom-8 md:w-[400px] bg-zinc-900/95 backdrop-blur-md border border-zinc-700 shadow-2xl rounded-2xl p-6 z-[999] transform transition-transform duration-500 translate-y-full">
        <div class="flex items-center gap-3 mb-3">
            <i class="fas fa-shield-alt text-cyan-500 text-xl"></i>
            <h3 class="text-white font-black uppercase tracking-widest text-sm">Privacidad y Telemetría</h3>
        </div>
        <p class="text-zinc-400 text-xs leading-relaxed mb-5 font-mono">
            En Velo Insights utilizamos cookies propias y de terceros para medir el rendimiento de la web (telemetría) y ofrecerte la mejor experiencia. 
            <a href="privacidad.html" class="text-cyan-400 hover:text-cyan-300 underline decoration-cyan-500/30">Leer política completa</a>.
        </p>
        <div class="flex flex-col sm:flex-row gap-3">
            <button id="btn-accept-cookies" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white text-[10px] font-black uppercase tracking-widest py-2.5 rounded-xl transition-colors shadow-[0_0_15px_rgba(6,182,212,0.3)]">
                Aceptar Todas
            </button>
            <button id="btn-reject-cookies" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[10px] font-bold uppercase tracking-widest py-2.5 rounded-xl border border-zinc-700 transition-colors">
                Solo Esenciales
            </button>
        </div>
    </div>

    <script>
        // Lógica del Banner de Cookies
        document.addEventListener('DOMContentLoaded', () => {
            const banner = document.getElementById('cookie-banner');
            const btnAccept = document.getElementById('btn-accept-cookies');
            const btnReject = document.getElementById('btn-reject-cookies');

            // Comprobar si ya tomó una decisión antes
            if (!localStorage.getItem('velo_cookies_consent')) {
                // Si no hay registro, mostramos el banner con una pequeña animación
                banner.classList.remove('hidden');
                setTimeout(() => {
                    banner.classList.remove('translate-y-full');
                }, 100);
            }

            // Función para guardar y ocultar
            const hideBanner = (decision) => {
                localStorage.setItem('velo_cookies_consent', decision);
                banner.classList.add('translate-y-full');
                setTimeout(() => {
                    banner.classList.add('hidden');
                }, 500);
            };

            if(btnAccept) btnAccept.addEventListener('click', () => hideBanner('accepted'));
            if(btnReject) btnReject.addEventListener('click', () => hideBanner('rejected'));
        });
    </script>
</body>
</html>
