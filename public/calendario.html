<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/svg+xml" href="assets/logo-icon.svg">
    <title>VELO INSIGHTS | Calendario 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/main.css">

    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #050505; }
        
        /* Transiciones generales */
        .race-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .race-card:hover { border-color: #52525b; }
        .race-card.active { border-color: #22d3ee; background-color: rgba(34, 211, 238, 0.05); }

        /* Acordeón NIVEL 1 (Carrera) */
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; background: #000; }
        .details-content.open { max-height: 3000px; border-top: 1px solid #27272a; }

        /* Acordeón NIVEL 2 (Etapas) */
        .stage-detail-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #0c0c0e; }
        .stage-detail-content.open { max-height: 500px; border-top: 1px dashed #27272a; padding-bottom: 10px; }

        /* Flechita de etapa */
        .stage-arrow { transition: transform 0.3s ease; }
        .stage-btn.active .stage-arrow { transform: rotate(180deg); color: #22d3ee; }
        .stage-btn.active .stage-name { color: #22d3ee; }

        /* Badges Categoría */
        .cat-GT { color: #ec4899; border: 1px solid rgba(236, 72, 153, 0.3); background: rgba(236, 72, 153, 0.1); }
        .cat-MONUMENT { color: #facc15; border: 1px solid rgba(250, 204, 21, 0.3); background: rgba(250, 204, 21, 0.1); }
        .cat-WT { color: #22d3ee; border: 1px solid rgba(34, 211, 238, 0.3); background: rgba(34, 211, 238, 0.1); }

        /* Badges Etapas */
        .badge-tt { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-montaña { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .badge-mediamontaña { background: rgba(234, 179, 8, 0.2); color: #facc15; }
        .badge-llano { background: rgba(34, 197, 94, 0.2); color: #4ade80; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>

<body class="bg-[#050505] antialiased min-h-screen pb-20 text-white selection:bg-cyan-500/30">

    <main class="max-w-5xl mx-auto px-4 md:px-6 py-28 md:py-40">
        
        <header class="mb-10 text-center reveal-on-scroll">
            <h1 class="text-4xl md:text-7xl font-black italic uppercase tracking-tighter leading-none mb-4">
                Calendario <span class="text-zinc-700">2026</span>
            </h1>
            
            <div class="max-w-md mx-auto relative group mb-8">
                <input type="text" id="search-input" placeholder="BUSCAR CARRERA..." 
                       class="w-full bg-zinc-900/50 border border-zinc-800 rounded-xl py-3 px-12 text-white outline-none focus:border-cyan-500 focus:bg-black transition-all text-center uppercase font-bold tracking-wider text-xs md:text-sm placeholder-zinc-700 backdrop-blur-sm">
            </div>

            <div class="flex flex-wrap justify-center gap-2 md:gap-3">
                <button onclick="filterRaces('ALL')" class="filter-btn active px-4 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-zinc-400 hover:text-white hover:border-zinc-600 transition-all bg-white/5">Todos</button>
                <button onclick="filterRaces('GT')" class="filter-btn px-4 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-pink-500 hover:bg-pink-500/10 hover:border-pink-500 transition-all">Grand Tours</button>
                <button onclick="filterRaces('MONUMENT')" class="filter-btn px-4 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-yellow-500 hover:bg-yellow-500/10 hover:border-yellow-500 transition-all">Monumentos</button>
                <button onclick="filterRaces('WT')" class="filter-btn px-4 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-cyan-500 hover:bg-cyan-500/10 hover:border-cyan-500 transition-all">World Tour</button>
            </div>
        </header>

        <div id="calendar-container" class="space-y-4"></div>

    </main>

    <script src="layout.js?v=5.5"></script>

    <script>
        const container = document.getElementById('calendar-container');
        const searchInput = document.getElementById('search-input');
        let allRaces = [];
        let currentFilter = 'ALL';

        async function initCalendar() {
            container.innerHTML = `<div class="text-center py-20 animate-pulse text-zinc-600 uppercase text-xs font-black">Cargando datos...</div>`;
            try {
                const response = await fetch('/api/calendar');
                if (response.ok) {
                    allRaces = await response.json();
                    renderCalendar(allRaces);
                } else { throw new Error('Error API'); }
            } catch (error) {
                container.innerHTML = `<div class="text-center py-20 text-red-500 text-xs font-bold">Error de conexión.</div>`;
            }
        }

        function renderCalendar(data) {
            if (data.length === 0) {
                container.innerHTML = `<div class="text-center py-20 border border-dashed border-zinc-800 rounded-3xl bg-zinc-900/20"><p class="text-zinc-600 font-bold uppercase text-xs">Sin resultados</p></div>`;
                return;
            }

            container.innerHTML = data.map((r, i) => {
                const dateObj = new Date(r.dateISO);
                const day = dateObj.getDate();
                const month = dateObj.toLocaleString('es-ES', { month: 'short' }).replace('.', '').toUpperCase();
                
                // Procesar Etapas (JSON)
                let stagesHTML = '';
                const stages = (r.details && r.details.stages) ? r.details.stages : [];
                
                if (stages.length > 0) {
                    stagesHTML = stages.map((s, j) => {
                        // Limpieza de tipo para la clase CSS
                        const typeClass = s.type ? s.type.toLowerCase().replace(/\s+/g, '') : 'llano';
                        
                        return `
                        <div class="border-b border-zinc-800 last:border-0">
                            
                            <button onclick="toggleStage(${i}, ${j})" id="stage-btn-${i}-${j}" class="stage-btn w-full p-4 hover:bg-white/5 transition-colors flex items-center justify-between gap-4 text-left group/stage">
                                <div class="flex items-center gap-3">
                                    <span class="font-heading text-lg text-zinc-500 w-6 text-center group-hover/stage:text-white transition-colors">${s.n}</span>
                                    <div>
                                        <h4 class="text-xs md:text-sm font-bold text-white uppercase stage-name transition-colors">${s.route || 'Etapa ' + s.n}</h4>
                                        <div class="flex items-center gap-2 mt-1.5">
                                            <span class="text-[9px] font-black badge-${typeClass} px-1.5 py-0.5 rounded uppercase">${s.type || 'Etapa'}</span>
                                            
                                            ${s.km ? `<span class="text-xs md:text-sm font-bold text-white font-mono border-l border-zinc-700 pl-2 ml-1">${s.km} km</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <div class="stage-arrow text-zinc-600">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </button>
                            
                            <div id="stage-content-${i}-${j}" class="stage-detail-content race-${i}-stage-content">
                                <div class="p-4 pt-0">
                                    ${s.gain ? `<p class="text-[10px] font-mono text-zinc-400 mb-2 text-center uppercase tracking-widest border-b border-zinc-800 pb-2">Desnivel Acumulado: <span class="text-white font-bold text-xs">${s.gain}m+</span></p>` : ''}
                                    
                                    ${s.image ? `
                                    <div class="bg-white rounded-lg p-2 overflow-hidden border border-zinc-700 opacity-90">
                                        <img src="${s.image}" loading="lazy" class="w-full h-auto object-contain max-h-[200px]" alt="Perfil etapa ${s.n}">
                                    </div>
                                    ` : `<p class="text-center text-[9px] text-zinc-600 italic py-2">Sin perfil disponible</p>`}
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                } else {
                    stagesHTML = `<div class="p-6 text-center text-zinc-600 text-xs italic">Detalles de etapas no disponibles.</div>`;
                }

                // Estado En Vivo
                const today = new Date().toISOString().split('T')[0];
                const isLive = r.dateISO === today;
                const statusBadge = isLive ? `<span class="bg-green-500 text-black text-[9px] font-black px-2 py-0.5 rounded animate-pulse ml-2">EN VIVO</span>` : '';

                return `
                <div id="card-${i}" class="race-card bg-zinc-900/40 border border-zinc-800 rounded-2xl overflow-hidden mb-4">
                    
                    <div class="p-5 flex items-center justify-between cursor-pointer" onclick="toggleDetails(${i})">
                        <div class="flex items-center gap-5">
                            <div class="flex flex-col items-center justify-center w-12 shrink-0 border-r border-zinc-800 pr-5">
                                <span class="text-3xl font-black italic text-white leading-none">${day}</span>
                                <span class="text-[10px] font-bold text-zinc-500 uppercase">${month}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center flex-wrap mb-1">
                                    <span class="text-[8px] font-black px-1.5 py-0.5 rounded uppercase cat-${r.category}">${r.category}</span>
                                    ${statusBadge}
                                </div>
                                <h3 class="text-white font-bold uppercase text-base md:text-lg tracking-tight truncate group-hover:text-cyan-400 transition-colors">${r.name}</h3>
                                <p class="text-[10px] text-zinc-500 uppercase tracking-wide mt-0.5 font-bold">
                                    ${stages.length > 0 ? `${stages.length} Etapas` : 'Clásica / 1 Día'}
                                </p>
                            </div>
                        </div>
                        <div class="w-8 h-8 rounded-full border border-zinc-700 flex items-center justify-center text-zinc-400 transition-all icon-toggle" id="icon-${i}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>

                    <div id="details-${i}" class="details-content">
                        ${stagesHTML}
                        <div class="p-4 bg-zinc-900 border-t border-zinc-800 flex justify-center">
                            <button onclick="addToCalendar('${r.name}', '${r.dateISO}')" class="flex items-center gap-2 text-[10px] font-bold text-zinc-400 hover:text-white uppercase transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Agendar en Google Calendar
                            </button>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        // --- LÓGICA DE ACORDEONES ---

        // 1. Abrir/Cerrar la Carrera completa
        function toggleDetails(index) {
            const content = document.getElementById(`details-${index}`);
            const card = document.getElementById(`card-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            const isOpen = content.classList.contains('open');
            
            // Cerrar otras carreras
            document.querySelectorAll('.details-content').forEach(el => el.classList.remove('open'));
            document.querySelectorAll('.race-card').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.icon-toggle').forEach(el => el.style.transform = 'rotate(0deg)');

            if(!isOpen) {
                content.classList.add('open');
                card.classList.add('active');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        // 2. Abrir/Cerrar UNA ETAPA ESPECÍFICA (y cerrar las demás de esa carrera)
        window.toggleStage = (raceIndex, stageIndex) => {
            const contentID = `stage-content-${raceIndex}-${stageIndex}`;
            const btnID = `stage-btn-${raceIndex}-${stageIndex}`;
            const targetContent = document.getElementById(contentID);
            const targetBtn = document.getElementById(btnID);
            
            const isAlreadyOpen = targetContent.classList.contains('open');

            // CERRAR TODAS las etapas de esta carrera
            const allStagesInRace = document.querySelectorAll(`.race-${raceIndex}-stage-content`);
            allStagesInRace.forEach(el => el.classList.remove('open'));
            
            // Quitar clase activa a todos los botones de esta carrera
            const parentDetails = document.getElementById(`details-${raceIndex}`);
            const allBtns = parentDetails.querySelectorAll('.stage-btn');
            allBtns.forEach(btn => btn.classList.remove('active'));

            // Si no estaba abierta, la abrimos ahora
            if (!isAlreadyOpen) {
                targetContent.classList.add('open');
                targetBtn.classList.add('active');
            }
        };

        function filterRaces(category) {
            currentFilter = category;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-white', 'text-black');
                btn.classList.add('bg-white/5', 'text-zinc-400');
            });
            event.target.classList.remove('bg-white/5', 'text-zinc-400');
            event.target.classList.add('active', 'bg-white', 'text-black');

            const term = searchInput.value.toLowerCase().trim();
            const filtered = allRaces.filter(r => {
                const matchesCategory = category === 'ALL' || r.category === category;
                const matchesSearch = r.name.toLowerCase().includes(term);
                return matchesCategory && matchesSearch;
            });
            renderCalendar(filtered);
        }

        function addToCalendar(title, dateStr) {
            const date = dateStr.replace(/-/g, ''); 
            window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${date}/${date}&details=Velo%20Insights%20WorldTour`, '_blank');
        }

        searchInput.addEventListener('input', () => filterRaces(currentFilter));
        document.addEventListener('DOMContentLoaded', initCalendar);
    </script>
</body>
</html>
