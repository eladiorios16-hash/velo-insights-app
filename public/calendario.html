<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/svg+xml" href="assets/logo-icon.svg">
    
    <title>VELO INSIGHTS | Calendario 2026</title>
    
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="/assets/icon-192.png">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('‚úÖ App registrada', reg.scope))
                    .catch(err => console.log('‚ùå Error registro App', err));
            });
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/main.css">

    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #050505; }
        
        .race-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .race-card:hover { border-color: #52525b; }
        .race-card.active { border-color: #22d3ee; background-color: rgba(34, 211, 238, 0.05); }

        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; background: #000; }
        .details-content.open { max-height: 3000px; border-top: 1px solid #27272a; }

        .stage-detail-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #0c0c0e; }
        .stage-detail-content.open { max-height: 800px; border-top: 1px dashed #27272a; padding-bottom: 10px; }

        .stage-arrow { transition: transform 0.3s ease; }
        .stage-btn.active .stage-arrow { transform: rotate(180deg); color: #22d3ee; }
        .stage-btn.active .stage-name { color: #22d3ee; }

        /* Categor√≠as y Badges */
        .cat-GT { color: #ec4899; border: 1px solid rgba(236, 72, 153, 0.3); background: rgba(236, 72, 153, 0.1); }
        .cat-MONUMENT { color: #facc15; border: 1px solid rgba(250, 204, 21, 0.3); background: rgba(250, 204, 21, 0.1); }
        .cat-WT { color: #22d3ee; border: 1px solid rgba(34, 211, 238, 0.3); background: rgba(34, 211, 238, 0.1); }

        .badge-tt { background: rgba(59, 130, 246, 0.2); color: #60a5fa; }
        .badge-cri { background: rgba(59, 130, 246, 0.2); color: #60a5fa; } /* Alias para TT */
        .badge-monta√±a { background: rgba(239, 68, 68, 0.2); color: #f87171; }
        .badge-mediamonta√±a { background: rgba(234, 179, 8, 0.2); color: #facc15; }
        .badge-llano { background: rgba(34, 197, 94, 0.2); color: #4ade80; }

        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        
        .filter-btn { transition: all 0.3s ease; background: transparent; }
        .filter-btn.active-all { border-color: #ffffff; color: #ffffff; background: rgba(255,255,255,0.05); box-shadow: 0 0 10px rgba(255,255,255,0.1); }
        .filter-btn.active-gt { border-color: #ec4899; color: #ec4899; background: rgba(236, 72, 153, 0.1); box-shadow: 0 0 15px rgba(236, 72, 153, 0.2); }
        .filter-btn.active-monument { border-color: #facc15; color: #facc15; background: rgba(250, 204, 21, 0.1); box-shadow: 0 0 15px rgba(250, 204, 21, 0.2); }
        .filter-btn.active-wt { border-color: #22d3ee; color: #22d3ee; background: rgba(34, 211, 238, 0.1); box-shadow: 0 0 15px rgba(34, 211, 238, 0.2); }

        /* Estilos del Perfil Interactivo */
        .profile-bar {
            transition: height 0.5s ease-out, background-color 0.2s, transform 0.2s;
            transform-origin: bottom;
        }
        .profile-bar:hover {
            transform: scaleY(1.1);
            filter: brightness(1.3);
            z-index: 10;
            cursor: pointer;
        }
    </style>
</head>

<body class="bg-[#050505] antialiased min-h-screen pb-20 text-white selection:bg-cyan-500/30">

    <main class="max-w-5xl mx-auto px-4 md:px-6 py-28 md:py-40">
        
        <header class="mb-10 text-center reveal-on-scroll">
            <h1 class="text-4xl md:text-7xl font-black italic uppercase tracking-tighter leading-none mb-4">
                Calendario <span class="text-zinc-700">2026</span>
            </h1>
            
            <div class="max-w-md mx-auto relative group mb-8">
                <input type="text" id="search-input" placeholder="BUSCAR CARRERA..." 
                       class="w-full bg-zinc-900/50 border border-zinc-800 rounded-xl py-3 px-12 text-white outline-none focus:border-cyan-500 focus:bg-black transition-all text-center uppercase font-bold tracking-wider text-xs md:text-sm placeholder-zinc-700 backdrop-blur-sm">
            </div>

            <div class="flex flex-wrap justify-center gap-3">
                <button id="btn-ALL" onclick="filterRaces('ALL')" class="filter-btn active-all px-5 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-zinc-500 hover:border-zinc-600 hover:text-zinc-300">Todos</button>
                <button id="btn-GT" onclick="filterRaces('GT')" class="filter-btn px-5 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-zinc-500 hover:border-pink-900 hover:text-pink-800">Grand Tours</button>
                <button id="btn-MONUMENT" onclick="filterRaces('MONUMENT')" class="filter-btn px-5 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-zinc-500 hover:border-yellow-900 hover:text-yellow-800">Monumentos</button>
                <button id="btn-WT" onclick="filterRaces('WT')" class="filter-btn px-5 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-zinc-500 hover:border-cyan-900 hover:text-cyan-800">World Tour</button>
            </div>
        </header>

        <div id="calendar-container" class="space-y-4"></div>

    </main>

    <script src="layout.js?v=5.5"></script>

    <script>
        const container = document.getElementById('calendar-container');
        const searchInput = document.getElementById('search-input');
        let allRaces = [];
        let currentFilter = 'ALL';

        async function initCalendar() {
            container.innerHTML = `<div class="text-center py-20 animate-pulse text-zinc-600 uppercase text-xs font-black">Cargando datos...</div>`;
            try {
                const response = await fetch('/api/calendar');
                
                if (response.ok) {
                    allRaces = await response.json();
                    renderCalendar(allRaces);
                } else { 
                    throw new Error('Error API'); 
                }
            } catch (error) {
                container.innerHTML = `<div class="text-center py-20 text-red-500 text-xs font-bold">Error de conexi√≥n (API).</div>`;
            }
        }

        function generateElevationGraph(stages, raceIndex) {
            if (!stages || stages.length === 0) return '';

            let barsHTML = '';
            
            stages.forEach((s, index) => {
                let height = '30%'; // Default
                let colorClass = 'bg-zinc-700';
                const type = s.type ? s.type.toLowerCase().replace(/\s+/g, '') : 'llano';
                
                if (type.includes('monta√±a') && !type.includes('media')) {
                    height = '100%';
                    colorClass = 'bg-gradient-to-t from-red-900 to-red-500';
                } else if (type.includes('media')) {
                    height = '60%';
                    colorClass = 'bg-gradient-to-t from-yellow-900 to-yellow-500';
                } else if (type.includes('llano')) {
                    height = '25%';
                    colorClass = 'bg-gradient-to-t from-green-900 to-green-500';
                } else if (type.includes('cri') || type.includes('tt')) {
                    height = '40%';
                    colorClass = 'bg-gradient-to-t from-blue-900 to-blue-500';
                }

                barsHTML += `
                    <div onclick="toggleStage(${raceIndex}, ${index}); event.stopPropagation();" 
                         title="Etapa ${s.n}: ${s.type || 'Etapa'}"
                         class="flex-1 mx-[1px] rounded-t-sm relative group/bar flex flex-col justify-end items-center"
                         style="height: 100%;">
                        <div class="w-full rounded-t-sm profile-bar ${colorClass} opacity-80 group-hover/bar:opacity-100" style="height: ${height}"></div>
                    </div>
                `;
            });

            return `
                <div class="px-5 py-6 bg-[#0a0a0a] border-b border-zinc-800">
                    <div class="flex justify-between items-end mb-2">
                         <span class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest">Perfil de Carrera</span>
                         <span class="text-[9px] font-mono text-zinc-600 uppercase">Interactive Chart</span>
                    </div>
                    <div class="h-24 w-full flex items-end border-b border-zinc-800 pb-px relative">
                         <div class="absolute w-full h-full border-t border-dashed border-zinc-800/30 top-0 left-0 pointer-events-none"></div>
                         <div class="absolute w-full h-1/2 border-t border-dashed border-zinc-800/30 top-0 left-0 pointer-events-none"></div>
                         
                         ${barsHTML}
                    </div>
                    <div class="flex justify-between mt-2">
                        <span class="text-[8px] text-zinc-600">E1</span>
                        <span class="text-[8px] text-zinc-600">FINAL</span>
                    </div>
                </div>
            `;
        }

        function renderCalendar(data) {
            if (data.length === 0) {
                container.innerHTML = `<div class="text-center py-20 border border-dashed border-zinc-800 rounded-3xl bg-zinc-900/20"><p class="text-zinc-600 font-bold uppercase text-xs">Sin resultados</p></div>`;
                return;
            }

            container.innerHTML = data.map((r, i) => {
                const dateObj = new Date(r.dateISO);
                const day = dateObj.getDate();
                const month = dateObj.toLocaleString('es-ES', { month: 'short' }).replace('.', '').toUpperCase();
                
                let stagesHTML = '';
                const stages = (r.details && r.details.stages) ? r.details.stages : [];
                
                const graphHTML = (stages.length > 1) ? generateElevationGraph(stages, i) : '';

                if (stages.length > 0) {
                    stagesHTML = stages.map((s, j) => {
                        const typeClass = s.type ? s.type.toLowerCase().replace(/\s+/g, '') : 'llano';
                        
                        const winnerHTML = s.winner ? 
                            `<div class="mt-1.5 flex items-center gap-1.5 animate-pulse-slow">
                                <svg class="w-3 h-3 text-amber-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
                                </svg>
                                <span class="text-[10px] font-black text-amber-400 uppercase tracking-wide border-b border-amber-400/20">${s.winner}</span>
                            </div>` : '';

                        return `
                        <div class="border-b border-zinc-800 last:border-0">
                            <button onclick="toggleStage(${i}, ${j})" id="stage-btn-${i}-${j}" class="stage-btn w-full p-4 hover:bg-white/5 transition-colors flex items-center justify-between gap-4 text-left group/stage">
                                <div class="flex items-center gap-3">
                                    <span class="font-heading text-lg text-zinc-500 w-6 text-center group-hover/stage:text-white transition-colors">${s.n}</span>
                                    <div>
                                        <h4 class="text-xs md:text-sm font-bold text-white uppercase stage-name transition-colors">${s.route || 'Etapa ' + s.n}</h4>
                                        <div class="flex flex-col">
                                            <div class="flex items-center gap-2 mt-1.5">
                                                <span class="text-[9px] font-black badge-${typeClass} px-1.5 py-0.5 rounded uppercase">${s.type || 'Etapa'}</span>
                                                ${s.km ? `<span class="text-xs md:text-sm font-bold text-white font-mono border-l border-zinc-700 pl-2 ml-1">${s.km} km</span>` : ''}
                                            </div>
                                            ${winnerHTML}
                                        </div>
                                    </div>
                                </div>
                                <div class="stage-arrow text-zinc-600">
                                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                                </div>
                            </button>
                            <div id="stage-content-${i}-${j}" class="stage-detail-content race-${i}-stage-content">
                                <div class="p-4 pt-0">
                                    ${s.gain ? `<p class="text-[10px] font-mono text-zinc-400 mb-2 text-center uppercase tracking-widest border-b border-zinc-800 pb-2">Desnivel Acumulado: <span class="text-white font-bold text-xs">${s.gain}m+</span></p>` : ''}
                                    ${s.image ? `
                                        <div class="bg-white rounded-xl p-1 md:p-2 overflow-hidden border border-white/10 shadow-[0_0_15px_rgba(255,255,255,0.05)] transition-all flex justify-center group/img">
                                            <img src="${s.image}" onclick="openLightbox(this.src)" loading="lazy" class="w-full h-auto object-contain max-h-[350px] md:max-h-[500px] cursor-pointer group-hover/img:scale-[1.02] transition-transform duration-300" alt="Perfil etapa ${s.n}">
                                        </div>
                                        <div class="mt-3 flex justify-end">
                                            <button onclick="shareStage('${r.name}', ${s.n}, '${s.route}', '${s.km}', '${s.gain}', '${s.image}')" 
                                                    class="flex items-center gap-2 px-3 py-1.5 rounded-full bg-cyan-500/10 border border-cyan-500/30 text-cyan-400 text-[10px] font-black uppercase hover:bg-cyan-500 hover:text-black transition-all">
                                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 100-2.684 3 3 0 000 2.684zm0 12a3 3 0 100-2.684 3 3 0 000 2.684z"></path></svg>
                                                Compartir Etapa
                                            </button>
                                        </div>
                                    ` : `
                                        <div class="bg-zinc-900 rounded-lg p-8 flex flex-col items-center border border-zinc-800">
                                            <img src="assets/logo-icon.svg" class="w-12 h-12 opacity-20 mb-2">
                                            <p class="text-[9px] text-zinc-600 uppercase font-bold tracking-widest text-center">Perfil no disponible para esta etapa</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>`;
                    }).join('');
                } else {
                    stagesHTML = `<div class="p-6 text-center text-zinc-600 text-xs italic">Detalles de etapas no disponibles.</div>`;
                }

                const today = new Date().toISOString().split('T')[0];
                const isLive = r.dateISO === today;
                const statusBadge = isLive ? `<span class="bg-green-500 text-black text-[9px] font-black px-2 py-0.5 rounded animate-pulse ml-2">EN VIVO</span>` : '';

                const raceWinnerBadge = r.winner ? `
                    <div class="mt-2 flex items-center gap-1.5">
                        <span class="bg-amber-500/20 border border-amber-500/40 text-amber-500 text-[8px] px-1.5 py-0.5 rounded font-black uppercase tracking-widest flex items-center gap-1">
                            <svg class="w-2.5 h-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 3v4M3 5h4M21 5h-4M19 3v4M9 11v3m-3 4h12M12 3v8m0 0a4 4 0 01-4-4m4 4a4 4 0 004-4"></path></svg>
                            GANADOR
                        </span>
                        <span class="text-xs font-black text-white uppercase tracking-wide">${r.winner}</span>
                    </div>
                ` : '';

                return `
                <div id="card-${i}" class="race-card bg-zinc-900/40 border border-zinc-800 rounded-2xl overflow-hidden mb-4">
                    <div class="p-5 flex items-center justify-between cursor-pointer" onclick="toggleDetails(${i})">
                        <div class="flex items-center gap-5">
                            <div class="flex flex-col items-center justify-center w-12 shrink-0 border-r border-zinc-800 pr-5">
                                <span class="text-3xl font-black italic text-white leading-none">${day}</span>
                                <span class="text-[10px] font-bold text-zinc-500 uppercase">${month}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <div class="flex items-center flex-wrap mb-1">
                                    <span class="text-[8px] font-black px-1.5 py-0.5 rounded uppercase cat-${r.category}">${r.category}</span>
                                    ${statusBadge}
                                </div>
                                <h3 class="text-white font-bold uppercase text-base md:text-lg tracking-tight truncate group-hover:text-cyan-400 transition-colors">${r.name}</h3>
                                <p class="text-[10px] text-zinc-500 uppercase tracking-wide mt-0.5 font-bold">
                                    ${stages.length > 0 ? `${stages.length} Etapas` : 'Cl√°sica / 1 D√≠a'}
                                </p>
                                ${raceWinnerBadge}
                            </div>
                        </div>
                        <div class="w-8 h-8 rounded-full border border-zinc-700 flex items-center justify-center text-zinc-400 transition-all icon-toggle" id="icon-${i}">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                        </div>
                    </div>
                    <div id="details-${i}" class="details-content">
                        ${graphHTML}
                        ${stagesHTML}
                        <div class="p-4 bg-zinc-900 border-t border-zinc-800 flex justify-center">
                            <button onclick="addToCalendar('${r.name}', '${r.dateISO}')" class="flex items-center gap-2 text-[10px] font-bold text-zinc-400 hover:text-white uppercase transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                                Agendar en Google Calendar
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function filterRaces(category) {
            currentFilter = category;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active-all', 'active-gt', 'active-monument', 'active-wt');
            });
            const activeBtn = document.getElementById(`btn-${category}`);
            if (activeBtn) {
                if (category === 'ALL') activeBtn.classList.add('active-all');
                else if (category === 'GT') activeBtn.classList.add('active-gt');
                else if (category === 'MONUMENT') activeBtn.classList.add('active-monument');
                else if (category === 'WT') activeBtn.classList.add('active-wt');
            }
            const term = searchInput.value.toLowerCase().trim();
            const filtered = allRaces.filter(r => {
                const matchesCategory = category === 'ALL' || r.category === category;
                const matchesSearch = r.name.toLowerCase().includes(term);
                return matchesCategory && matchesSearch;
            });
            renderCalendar(filtered);
        }

        function toggleDetails(index) {
            const content = document.getElementById(`details-${index}`);
            const card = document.getElementById(`card-${index}`);
            const icon = document.getElementById(`icon-${index}`);
            const isOpen = content.classList.contains('open');
            document.querySelectorAll('.details-content').forEach(el => el.classList.remove('open'));
            document.querySelectorAll('.race-card').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.icon-toggle').forEach(el => el.style.transform = 'rotate(0deg)');
            if(!isOpen) {
                content.classList.add('open');
                card.classList.add('active');
                icon.style.transform = 'rotate(180deg)';
            }
        }

        window.toggleStage = (raceIndex, stageIndex) => {
            const contentID = `stage-content-${raceIndex}-${stageIndex}`;
            const btnID = `stage-btn-${raceIndex}-${stageIndex}`;
            const targetContent = document.getElementById(contentID);
            const targetBtn = document.getElementById(btnID);
            const isAlreadyOpen = targetContent.classList.contains('open');
            const allStagesInRace = document.querySelectorAll(`.race-${raceIndex}-stage-content`);
            allStagesInRace.forEach(el => el.classList.remove('open'));
            const parentDetails = document.getElementById(`details-${raceIndex}`);
            const allBtns = parentDetails.querySelectorAll('.stage-btn');
            allBtns.forEach(btn => btn.classList.remove('active'));
            
            if (!isAlreadyOpen) {
                targetContent.classList.add('open');
                targetBtn.classList.add('active');
            }
        };

        window.shareStage = (raceName, stageNum, route, km, gain, imageUrl) => {
            const text = `üö¥‚Äç‚ôÇÔ∏è Perfil T√©cnico: ${raceName}\nüìç Etapa ${stageNum}: ${route}\nüìè Distancia: ${km} km\n‚õ∞Ô∏è Desnivel: ${gain} m+\n\n${imageUrl ? `üñºÔ∏è Perfil: ${imageUrl}\n` : ''}\nAnalizado en Velo Insights ‚ö°`;
            const url = window.location.href;

            if (navigator.share) {
                navigator.share({
                    title: `Etapa ${stageNum} - ${raceName}`,
                    text: text,
                    url: url
                }).catch((error) => console.log('Error compartiendo:', error));
            } else {
                const dummy = document.createElement("textarea");
                document.body.appendChild(dummy);
                dummy.value = text + " " + url;
                dummy.select();
                document.execCommand("copy");
                document.body.removeChild(dummy);
                alert("Copiado al portapapeles: ¬°P√©galo donde quieras!");
            }
        };

        function addToCalendar(title, dateStr) {
            const date = dateStr.replace(/-/g, ''); 
            window.open(`https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${date}/${date}&details=Velo%20Insights%20WorldTour`, '_blank');
        }

        searchInput.addEventListener('input', () => filterRaces(currentFilter));
        document.addEventListener('DOMContentLoaded', initCalendar);
    </script>
</body>
</html>
