<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/svg+xml" href="assets/logo-icon.svg">
    <title>VELO INSIGHTS | Calendario Deck 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Inter:wght@400;900&display=swap" rel="stylesheet">

    <style>
        :root { --accent-color: #22d3ee; }
        body { 
            background-color: #050505; 
            font-family: 'Inter', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .font-mono { font-family: 'JetBrains Mono', monospace; }

        /* Mejora 1: Glassmorphism Header */
        .glass-header {
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            background: rgba(5, 5, 5, 0.75);
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Mejora 2: Skeleton Screens */
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }
        .skeleton {
            background: linear-gradient(90deg, #0a0a0a 25%, #151515 50%, #0a0a0a 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite linear;
            border-radius: 16px;
        }

        /* Mejora 3: Dynamic Glow & Hover */
        .race-card { 
            transition: all 0.4s cubic-bezier(0.23, 1, 0.32, 1);
            position: relative;
        }
        .race-card:hover { border-color: rgba(255,255,255,0.15); background: rgba(255,255,255,0.02); }
        .race-card.active { 
            border-color: var(--accent-color);
            box-shadow: 0 0 30px rgba(var(--accent-rgb), 0.1);
        }

        .details-content { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.7s cubic-bezier(0.4, 0, 0.2, 1); 
        }
        .details-content.open { max-height: 4000px; }

        /* Categorías con neón sutil */
        .cat-GT { color: #ec4899; border-color: rgba(236, 72, 153, 0.3); box-shadow: 0 0 10px rgba(236, 72, 153, 0.1); }
        .cat-WT { color: #22d3ee; border-color: rgba(34, 211, 238, 0.3); box-shadow: 0 0 10px rgba(34, 211, 238, 0.1); }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>

<body class="text-zinc-100 antialiased selection:bg-cyan-500/30">

    <nav class="fixed top-0 w-full z-50 glass-header px-4 py-4">
        <div class="max-w-5xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-2 group cursor-pointer">
                <div class="w-8 h-8 bg-white text-black rounded flex items-center justify-center font-black italic text-xl transition-transform group-hover:scale-110">V</div>
                <span class="font-black uppercase tracking-tighter text-xs hidden md:block">Velo <span class="text-zinc-500 italic">Insights</span></span>
            </div>
            
            <div class="flex-1 max-w-sm mx-6">
                <input type="text" id="search-input" placeholder="BUSCAR TELEMETRÍA..." 
                       class="w-full bg-white/5 border border-white/10 rounded-lg py-2 px-4 text-[10px] outline-none focus:border-white/40 transition-all font-mono tracking-widest uppercase">
            </div>

            <div class="flex items-center gap-3">
                <span class="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span>
                <span class="text-[9px] font-bold text-zinc-500 uppercase font-mono">System.Live</span>
            </div>
        </div>
    </nav>

    <main class="max-w-5xl mx-auto px-4 pt-32 pb-20">
        
        <header class="mb-12 text-center relative">
            <h1 class="text-6xl md:text-9xl font-black italic uppercase tracking-tighter leading-none opacity-[0.03] absolute -top-10 left-0 right-0 pointer-events-none">DATA2026</h1>
            <div class="relative z-10">
                <p class="text-[10px] font-mono text-cyan-500 tracking-[0.4em] uppercase mb-2">Calendario Profesional</p>
                <div class="flex flex-wrap gap-2 justify-center">
                    <button onclick="filterRaces('ALL')" class="bg-white/5 border border-white/10 px-5 py-1.5 rounded text-[9px] font-bold uppercase hover:bg-white/10 transition-all">Todos</button>
                    <button onclick="filterRaces('GT')" class="bg-pink-500/10 border border-pink-500/20 px-5 py-1.5 rounded text-[9px] font-bold uppercase text-pink-500 hover:bg-pink-500/20 transition-all">Grand Tours</button>
                    <button onclick="filterRaces('WT')" class="bg-cyan-500/10 border border-cyan-500/20 px-5 py-1.5 rounded text-[9px] font-bold uppercase text-cyan-500 hover:bg-cyan-500/20 transition-all">WorldTour</button>
                </div>
            </div>
        </header>

        <div id="calendar-container" class="space-y-4">
            <div class="skeleton h-24 w-full"></div>
            <div class="skeleton h-24 w-full"></div>
            <div class="skeleton h-24 w-full"></div>
            <div class="skeleton h-24 w-full"></div>
        </div>

    </main>

    <script>
        const container = document.getElementById('calendar-container');
        const searchInput = document.getElementById('search-input');
        let allRaces = [];

        // Mejora: Colores dinámicos por carrera
        function getRaceTheme(name) {
            if (name.toLowerCase().includes('giro')) return { color: '#ec4899', rgb: '236, 72, 153' };
            if (name.toLowerCase().includes('tour')) return { color: '#facc15', rgb: '250, 204, 21' };
            if (name.toLowerCase().includes('vuelta') || name.toLowerCase().includes('uae')) return { color: '#ef4444', rgb: '239, 68, 68' };
            return { color: '#22d3ee', rgb: '34, 211, 238' };
        }

        async function initCalendar() {
            try {
                // Simulación de carga para apreciar el Skeleton Screen
                await new Promise(r => setTimeout(r, 1000));
                
                const response = await fetch('/api/calendar');
                if (response.ok) {
                    allRaces = await response.json();
                    renderCalendar(allRaces);
                }
            } catch (error) {
                container.innerHTML = `<div class="text-center py-20 font-mono text-zinc-600 text-xs">Error: Link.Sync_Failed</div>`;
            }
        }

        function renderCalendar(data) {
            if (data.length === 0) {
                container.innerHTML = `<div class="py-20 text-center border border-white/5 rounded-3xl text-zinc-600 font-mono text-xs italic uppercase">No se encontraron registros activos</div>`;
                return;
            }

            container.innerHTML = data.map((r, i) => {
                const theme = getRaceTheme(r.name);
                const dateObj = new Date(r.dateISO);
                const day = dateObj.getDate().toString().padStart(2, '0');
                const month = dateObj.toLocaleString('es-ES', { month: 'short' }).toUpperCase();
                
                const stages = (r.details && r.details.stages) ? r.details.stages : [];

                return `
                <div id="card-${i}" class="race-card bg-[#0c0c0e] border border-white/5 rounded-2xl overflow-hidden" 
                     style="--accent-color: ${theme.color}; --accent-rgb: ${theme.rgb}">
                    
                    <div class="p-6 flex items-center justify-between cursor-pointer" onclick="toggleDetails(${i})">
                        <div class="flex items-center gap-6">
                            <div class="flex flex-col items-center border-r border-white/5 pr-6">
                                <span class="text-4xl font-black italic font-mono tracking-tighter">${day}</span>
                                <span class="text-[9px] font-bold text-zinc-500 uppercase tracking-widest">${month}</span>
                            </div>
                            <div class="min-w-0">
                                <span class="text-[8px] font-black px-2 py-0.5 rounded border border-white/10 uppercase mb-2 inline-block cat-${r.category}">${r.category}</span>
                                <h3 class="text-white font-bold uppercase text-lg md:text-xl tracking-tighter truncate">${r.name}</h3>
                                <p class="text-[9px] font-mono text-zinc-500 uppercase tracking-widest mt-1">${stages.length || '1'} EVENTOS REGISTRADOS</p>
                            </div>
                        </div>
                        <div class="icon-indicator w-10 h-10 rounded-full border border-white/5 flex items-center justify-center text-zinc-500 transition-all">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                        </div>
                    </div>

                    <div id="details-${i}" class="details-content">
                        <div class="p-2 space-y-1 border-t border-white/5 bg-black/50">
                            ${stages.map((s, j) => {
                                // CORRECCIÓN: Referencia directa a winner
                                const winner = s.winner; 
                                return `
                                <div class="bg-white/[0.01] border border-white/[0.03] rounded-xl p-4 flex items-center justify-between hover:bg-white/[0.03] transition-all">
                                    <div class="flex items-center gap-4">
                                        <div class="w-8 h-8 rounded border border-white/10 flex items-center justify-center font-mono text-xs text-zinc-500">${s.n}</div>
                                        <div>
                                            <p class="text-xs font-bold uppercase text-zinc-200">${s.route || 'Etapa '+s.n}</p>
                                            <div class="flex items-center gap-3 mt-1 font-mono text-[9px] text-zinc-500 uppercase">
                                                <span>${s.km} KM</span>
                                                <span class="w-1 h-1 bg-zinc-800 rounded-full"></span>
                                                <span>${s.gain || 0}M+</span>
                                                <span class="w-1 h-1 bg-zinc-800 rounded-full"></span>
                                                <span class="text-cyan-500">${s.type}</span>
                                            </div>
                                        </div>
                                    </div>
                                    ${winner ? `
                                        <div class="text-right pl-4">
                                            <span class="text-[7px] font-black text-zinc-600 block uppercase mb-0.5">Top Position</span>
                                            <span class="text-[10px] font-bold text-amber-500 uppercase bg-amber-500/5 px-2 py-1 rounded border border-amber-500/20">${winner}</span>
                                        </div>
                                    ` : ''}
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function toggleDetails(index) {
            const content = document.getElementById(`details-${index}`);
            const card = document.getElementById(`card-${index}`);
            const isOpen = content.classList.contains('open');
            
            document.querySelectorAll('.details-content').forEach(el => el.classList.remove('open'));
            document.querySelectorAll('.race-card').forEach(el => el.classList.remove('active'));

            if(!isOpen) {
                content.classList.add('open');
                card.classList.add('active');
            }
        }

        function filterRaces(category) {
            const term = searchInput.value.toLowerCase().trim();
            const filtered = allRaces.filter(r => {
                const matchesCategory = category === 'ALL' || r.category === category;
                const matchesSearch = r.name.toLowerCase().includes(term);
                return matchesCategory && matchesSearch;
            });
            renderCalendar(filtered);
        }

        searchInput.addEventListener('input', () => filterRaces('ALL'));
        document.addEventListener('DOMContentLoaded', initCalendar);
    </script>
</body>
</html>
