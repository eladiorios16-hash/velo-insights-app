<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/svg+xml" href="assets/logo-icon.svg">
    <title>VELO INSIGHTS | Calendario 2026</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/main.css">

    <style>
        body { -webkit-tap-highlight-color: transparent; background-color: #050505; }
        
        /* Animaciones y Transiciones */
        .race-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .race-card:hover { transform: translateY(-2px); border-color: #3f3f46; }
        
        /* Badges de Categoría */
        .cat-GT { background: rgba(236, 72, 153, 0.1); color: #ec4899; border: 1px solid rgba(236, 72, 153, 0.3); }
        .cat-MONUMENT { background: rgba(250, 204, 21, 0.1); color: #facc15; border: 1px solid rgba(250, 204, 21, 0.3); }
        .cat-WT { background: rgba(34, 211, 238, 0.1); color: #22d3ee; border: 1px solid rgba(34, 211, 238, 0.3); }
        
        /* Estado En Vivo */
        @keyframes pulse-live { 0% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); } 70% { box-shadow: 0 0 0 6px rgba(34, 197, 94, 0); } 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0); } }
        .status-live { border-color: #22c55e !important; animation: pulse-live 2s infinite; }

        /* Filtros Activos */
        .filter-btn.active { background-color: #fff; color: #000; border-color: #fff; }

        /* Acordeón */
        .details-content { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; background: #09090b; }
        .details-content.open { max-height: 1000px; border-top: 1px solid #27272a; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
    
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">
</head>

<body class="bg-[#050505] antialiased overflow-x-hidden selection:bg-cyan-500/30 selection:text-cyan-200 min-h-screen pb-20">

    <main class="max-w-5xl mx-auto px-4 md:px-6 py-28 md:py-40">
        
        <header class="mb-10 text-center reveal-on-scroll">
            <h1 class="text-4xl md:text-7xl font-black text-white italic uppercase tracking-tighter leading-none mb-4">
                Calendario <span class="text-zinc-700">2026</span>
            </h1>
            
            <div class="max-w-md mx-auto relative group mb-8">
                <input type="text" id="search-input" placeholder="BUSCAR CARRERA..." 
                       class="w-full bg-zinc-900/50 border border-zinc-800 rounded-xl py-3 px-12 text-white outline-none focus:border-cyan-500 focus:bg-black transition-all text-center uppercase font-bold tracking-wider text-xs md:text-sm placeholder-zinc-700 backdrop-blur-sm">
            </div>

            <div class="flex flex-wrap justify-center gap-2 md:gap-3">
                <button onclick="filterRaces('ALL')" class="filter-btn active px-4 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-zinc-400 hover:text-white hover:border-zinc-600 transition-all">Todos</button>
                <button onclick="filterRaces('GT')" class="filter-btn px-4 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-pink-500 hover:bg-pink-500/10 hover:border-pink-500 transition-all">Grand Tours</button>
                <button onclick="filterRaces('MONUMENT')" class="filter-btn px-4 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-yellow-500 hover:bg-yellow-500/10 hover:border-yellow-500 transition-all">Monumentos</button>
                <button onclick="filterRaces('WT')" class="filter-btn px-4 py-2 rounded-lg border border-zinc-800 text-[10px] font-bold uppercase text-cyan-500 hover:bg-cyan-500/10 hover:border-cyan-500 transition-all">World Tour</button>
            </div>
        </header>

        <div id="calendar-container" class="space-y-3 md:grid md:grid-cols-2 md:gap-4 md:space-y-0">
             </div>

    </main>

    <script src="layout.js?v=5.5"></script>

    <script>
        const container = document.getElementById('calendar-container');
        const searchInput = document.getElementById('search-input');
        let allRaces = [];
        let currentFilter = 'ALL';

        async function initCalendar() {
            container.innerHTML = `<div class="col-span-full text-center py-20 animate-pulse text-zinc-600 uppercase text-xs font-black">Sincronizando fechas...</div>`;

            try {
                const response = await fetch('/api/calendar');
                if (response.ok) {
                    allRaces = await response.json();
                    renderCalendar(allRaces);
                } else {
                    throw new Error('Error API');
                }
            } catch (error) {
                console.error(error);
                container.innerHTML = `<div class="col-span-full text-center py-20 text-red-500 text-xs font-bold">Error de conexión.</div>`;
            }
        }

        function renderCalendar(data) {
            const today = new Date().toISOString().split('T')[0];
            
            if (data.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center py-20 border border-dashed border-zinc-800 rounded-3xl bg-zinc-900/20"><p class="text-zinc-600 font-bold uppercase text-xs">Sin resultados</p></div>`;
                return;
            }

            container.innerHTML = data.map((r, i) => {
                // Formato de Fecha
                const dateObj = new Date(r.dateISO);
                const day = dateObj.getDate();
                const month = dateObj.toLocaleString('es-ES', { month: 'short' }).replace('.', '').toUpperCase();
                
                // Estado y Estilos
                let statusBadge = '';
                let cardClass = '';
                let opacityClass = '';
                
                if (r.dateISO === today) {
                    statusBadge = `<span class="bg-green-500 text-black text-[9px] font-black px-2 py-0.5 rounded animate-pulse ml-2">EN VIVO</span>`;
                    cardClass = 'status-live';
                } else if (r.dateISO < today && r.status !== 'Upcoming') {
                    statusBadge = `<span class="text-zinc-600 text-[9px] font-bold uppercase ml-2 border border-zinc-800 px-1.5 rounded">Finalizado</span>`;
                    opacityClass = 'opacity-60 grayscale hover:grayscale-0 hover:opacity-100';
                }

                // Detalles
                let typeInfo = "Carrera";
                if(r.details && typeof r.details === 'object' && r.details.type) {
                    typeInfo = r.details.type;
                }

                return `
                <div class="race-card group relative bg-zinc-900/40 border border-zinc-800 rounded-xl overflow-hidden ${cardClass} ${opacityClass} flex flex-col">
                    
                    <div class="p-4 flex items-center justify-between cursor-pointer" onclick="toggleDetails(${i})">
                        <div class="flex items-center gap-4">
                            <div class="flex flex-col items-center justify-center w-12 shrink-0 border-r border-zinc-800 pr-4">
                                <span class="text-2xl font-black italic text-white leading-none">${day}</span>
                                <span class="text-[10px] font-bold text-zinc-500 uppercase">${month}</span>
                            </div>

                            <div class="flex-1 min-w-0">
                                <div class="flex items-center flex-wrap mb-1">
                                    <span class="text-[8px] font-black px-1.5 py-0.5 rounded uppercase cat-${r.category}">${r.category}</span>
                                    ${statusBadge}
                                </div>
                                <h3 class="text-white font-bold uppercase text-sm md:text-base tracking-tight truncate group-hover:text-cyan-400 transition-colors">${r.name}</h3>
                                <p class="text-[10px] text-zinc-500 font-medium uppercase tracking-wide mt-0.5">${typeInfo}</p>
                            </div>
                        </div>

                        <button onclick="event.stopPropagation(); addToCalendar('${r.name}', '${r.dateISO}')" class="ml-2 w-8 h-8 rounded-full bg-zinc-800 hover:bg-white hover:text-black text-zinc-400 flex items-center justify-center transition-all border border-zinc-700 z-20 relative" title="Agendar en Google Calendar">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>

                    <div id="details-${i}" class="details-content px-4">
                        <div class="py-4 text-xs text-zinc-400 font-mono border-t border-zinc-800/50">
                            <p>Más información disponible próximamente.</p>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }

        function filterRaces(category) {
            currentFilter = category;
            
            // Actualizar botones
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
                btn.classList.add('text-zinc-400', 'border-zinc-800');
            });
            event.target.classList.add('active');
            event.target.classList.remove('text-zinc-400', 'text-pink-500', 'text-yellow-500', 'text-cyan-500');

            // Filtrar datos
            const term = searchInput.value.toLowerCase().trim();
            const filtered = allRaces.filter(r => {
                const matchesCategory = category === 'ALL' || r.category === category;
                const matchesSearch = r.name.toLowerCase().includes(term);
                return matchesCategory && matchesSearch;
            });
            renderCalendar(filtered);
        }

        function toggleDetails(index) {
            const content = document.getElementById(`details-${index}`);
            const isOpen = content.classList.contains('open');
            // Cerrar otros
            document.querySelectorAll('.details-content').forEach(el => el.classList.remove('open'));
            
            if(!isOpen) content.classList.add('open');
        }

        function addToCalendar(title, dateStr) {
            const date = dateStr.replace(/-/g, ''); 
            const googleUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodeURIComponent(title)}&dates=${date}/${date}&details=Carrera%20WorldTour%202026%20-%20Velo%20Insights`;
            window.open(googleUrl, '_blank');
        }

        searchInput.addEventListener('input', () => filterRaces(currentFilter));

        document.addEventListener('DOMContentLoaded', initCalendar);
    </script>
</body>
</html>
