<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/svg+xml" href="assets/logo-icon.svg">
    
    <title>VELO INSIGHTS | WorldTour</title>
    <meta name="description" content="Análisis de datos, calendario y rendimiento del ciclismo WorldTour.">

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Velo Insights">
    <link rel="apple-touch-icon" href="assets/icon-192.png">

    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(reg => console.log('✅ App registrada', reg.scope))
                    .catch(err => console.log('❌ Error registro App', err));
            });
        }
    </script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/main.css">
    
    <style>
        /* ESTILOS BASE */
        body { -webkit-tap-highlight-color: transparent; }
        
        .live-dot { width: 6px; height: 6px; background-color: #ef4444; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* Timeline Mejorado */
        .timeline-container {
            background: linear-gradient(180deg, rgba(17, 17, 26, 0.95) 0%, rgba(5,5,5,1) 100%);
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            position: relative; overflow: hidden;
        }
        .mask-linear {
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }
        
        .custom-scrollbar::-webkit-scrollbar { height: 0px; width: 0px; display: none; }
        .custom-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .timeline-tick { width: 1px; height: 12px; background-color: #3f3f46; margin: 0 auto; transition: all 0.3s; }
        
        /* Modificación para soportar altura variable si hay muchas carreras */
        .timeline-day { flex: 0 0 52px; height: 75px; display: flex; flex-direction: column; justify-content: start; align-items: center; padding-top: 10px; transition: all 0.2s; position: relative; cursor: pointer; }
        
        /* Estado Activo */
        .day-active { background: rgba(139, 92, 246, 0.05); }
        .day-active .timeline-tick { display: none; } /* Ocultamos el tick si hay carrera */
        
        .day-number { font-size: 0.9rem; color: #71717a; font-weight: 700; margin-bottom: 4px; transition: color 0.3s; }
        .day-active .day-number { color: #e4e4e7; }
        .day-today .day-number { color: #38bdf8; text-shadow: 0 0 10px rgba(56, 189, 248, 0.5); font-size: 1.1rem; }

        .day-month { display: block; color: #a1a1aa; font-size: 8px; font-weight: 900; text-transform: uppercase; margin-bottom: 2px; }
        
        .day-empty .day-number { font-size: 0.65rem; color: #52525b; font-weight: 500; margin-bottom: 6px; }

        /* Comparison Card */
        .comparison-card { background: linear-gradient(180deg, rgba(6, 25, 20, 0.6) 0%, rgba(5,5,5,0.9) 100%); position: relative; overflow: hidden; border: 1px solid rgba(16, 185, 129, 0.15); }
        .stage-profile-bg { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; 
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 300' preserveAspectRatio='none'%3E%3Cpath d='M0,300 L50,280 L150,250 L300,200 L450,150 L600,100 L750,50 L900,20 L1000,300 Z' fill='rgba(16, 185, 129, 0.05)' /%3E%3Cpath d='M0,300 L50,280 L150,250 L300,200 L450,150 L600,100 L750,50 L900,20 L1000,0' fill='none' stroke='rgba(16, 185, 129, 0.15)' stroke-width='1.5' vector-effect='non-scaling-stroke'/%3E%3C/svg%3E") no-repeat bottom; 
            background-size: cover; pointer-events: none; z-index: 0; 
        }

        input[type=range].slider-green { -webkit-appearance: none; background: #27272a; height: 4px; border-radius: 2px; width: 100%; }
        input[type=range].slider-green::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #10b981; cursor: pointer; border: 2px solid #064e3b; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); margin-top: -8px; }
    </style>
</head>

<body class="bg-[#050505] antialiased overflow-x-hidden selection:bg-cyan-500/30 selection:text-cyan-200 pb-20">

    <div id="live-race-banner" class="hidden fixed bottom-0 left-0 w-full z-[100] bg-gradient-to-r from-red-900/95 to-black border-t border-red-500/30 backdrop-blur-md transition-all shadow-[0_-5px_20px_rgba(220,38,38,0.3)]">
        <div class="max-w-7xl mx-auto px-5 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3 overflow-hidden">
                <span class="flex h-2 w-2 relative flex-shrink-0">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                </span>
                <p class="text-[10px] font-black uppercase text-white tracking-widest truncate">
                    LIVE: <span id="live-race-name" class="text-red-400">--</span>
                </p>
            </div>
            <a href="#" id="live-race-link" class="flex-shrink-0 text-[9px] font-bold uppercase text-white bg-red-600 hover:bg-red-500 transition-colors px-4 py-1.5 rounded-full shadow-lg shadow-red-900/50">Ver</a>
        </div>
    </div>

    <header class="relative pt-28 md:pt-40 pb-6 px-4 text-center">
        <div class="max-w-4xl mx-auto mb-2 animate-fade-in-up">
            <p class="text-cyan-500 font-bold tracking-[0.2em] text-[9px] uppercase mb-3">VELO INSIGHTS</p>
            <h1 class="text-5xl md:text-8xl font-heading text-white italic uppercase tracking-tighter leading-[0.9] drop-shadow-2xl">
                Data <span class="text-zinc-700">Driven</span><br>Cycling
            </h1>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 md:px-6 space-y-12 pb-12">
        
        <section class="mb-6">
            <div class="flex justify-between items-baseline mb-6 px-1 border-b border-zinc-800/60 pb-3">
                <h3 class="text-xl font-heading text-white italic uppercase tracking-tight">ULTIMAS <span class="text-cyan-500">NOTICIAS</span></h3>
                <a href="noticias.html" class="text-[10px] font-bold text-zinc-500 hover:text-cyan-400 uppercase tracking-widest transition-colors">Ver Journal →</a>
            </div>
            
            <div id="latest-news-container" class="w-full">
                <div class="h-64 bg-zinc-900/50 rounded-2xl animate-pulse flex items-center justify-center border border-zinc-800/50">
                    <span class="text-[10px] text-zinc-600 font-bold uppercase tracking-widest">Conectando con el Lab...</span>
                </div>
            </div>
        </section>

        <section>
            <div class="flex justify-between items-end px-2 mb-3">
                <div class="text-left overflow-hidden">
                    <h3 id="timeline-race-name" class="text-lg font-heading text-white italic uppercase leading-none transition-all truncate pr-2">Cargando...</h3>
                    <div id="timeline-race-meta" class="opacity-0 transition-opacity flex items-center gap-2 text-[9px] font-bold uppercase mt-1">
                        <span id="meta-cat" class="px-1.5 py-0.5 rounded border">--</span>
                        <a id="meta-link" href="#" class="text-zinc-400 hover:text-white underline decoration-zinc-700">Ficha Técnica</a>
                    </div>
                </div>
                <span id="timeline-month-label" class="text-[9px] font-black text-zinc-600 uppercase tracking-widest whitespace-nowrap">--</span>
            </div>
            <div class="timeline-container rounded-xl shadow-2xl shadow-violet-900/10">
                <div id="timeline-scroll" class="flex overflow-x-auto custom-scrollbar pb-0 cursor-grab active:cursor-grabbing select-none py-2 px-4 mask-linear">
                    </div>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 md:gap-12">
            
            <aside class="bg-zinc-900/30 border border-zinc-800 rounded-2xl p-5">
                <h3 class="text-base font-heading text-white italic uppercase mb-4 border-b border-zinc-800 pb-2">PROXIMAS <span class="text-yellow-500">CARRERAS</span></h3>
                <div id="upcoming-races" class="space-y-2">
                    <p class="text-[10px] text-zinc-500 text-center py-4 tracking-widest uppercase animate-pulse">Sincronizando fechas...</p>
                </div>
            </aside>

            <aside class="bg-zinc-900/30 border border-zinc-800 rounded-2xl p-5 backdrop-blur-sm">
                <div class="flex justify-between items-end mb-4 border-b border-zinc-800 pb-2">
                    <h3 class="text-base font-heading text-white italic uppercase">UCI <span class="text-amber-500">RANKING</span></h3>
                    <a href="ranking.html" class="text-[9px] font-bold text-zinc-600 hover:text-amber-500 uppercase transition-colors">TOP 5</a>
                </div>
                <div id="ranking-list" class="space-y-1">
                    <p class="text-[10px] text-zinc-500 text-center py-4 tracking-widest uppercase animate-pulse">Obteniendo puntos...</p>
                </div>
            </aside>

        </div>

        <section class="comparison-card rounded-2xl p-5 md:p-8 opacity-90 hover:opacity-100 transition-opacity">
            <div class="stage-profile-bg"></div>

            <div class="relative z-10">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-sm font-heading text-white italic uppercase">Pro vs Amateur</h3>
                        <p class="text-[9px] text-zinc-500">Ref: Alpe d'Huez (13.8km @ 8.1%)</p>
                    </div>
                    <div id="level-tag" class="text-emerald-400 text-[10px] font-black uppercase tracking-widest backdrop-blur-sm bg-black/40 border border-emerald-500/30 px-3 py-1 rounded">--</div>
                </div>

                <div class="mb-6 border-l-2 border-zinc-700 pl-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] font-bold uppercase text-zinc-400">Tadej Pogačar</span>
                        <span class="text-xs font-mono text-white font-bold">39' 50"</span>
                    </div>
                    <div class="flex justify-between text-[9px] font-mono text-zinc-500">
                        <span>~445 Watts</span>
                        <span>6.8 W/kg</span>
                    </div>
                    <div class="h-1 bg-zinc-800 rounded-full mt-2 overflow-hidden w-full">
                        <div class="h-full bg-white w-full shadow-[0_0_10px_white]"></div>
                    </div>
                </div>

                <div class="mb-4 border-l-2 border-emerald-500 pl-3">
                    <div class="flex justify-between items-center mb-1">
                        <span class="text-[9px] font-bold uppercase text-emerald-500">Tu Nivel Estimado</span>
                        <span id="amateur-time" class="text-xs font-mono text-white font-bold">--</span>
                    </div>
                    <div class="flex justify-between text-[9px] font-mono text-emerald-400/80">
                        <span id="amateur-watts">-- Watts</span>
                        <span id="amateur-wkg">-- W/kg</span>
                    </div>
                    <div class="h-1 bg-zinc-800 rounded-full mt-2 overflow-hidden w-full">
                        <div id="amateur-bar" class="h-full bg-emerald-500 w-[50%] shadow-[0_0_10px_#10b981]"></div>
                    </div>
                </div>

                <div class="pt-2">
                    <input type="range" min="1" max="10" value="4" class="slider-green w-full block" id="level-slider">
                    <div class="flex justify-between text-[8px] font-bold text-zinc-600 uppercase mt-2 tracking-widest">
                        <span>Globero</span><span>World Tour</span>
                    </div>
                </div>
            </div>
        </section>

    </main>
    
    <script src="renderers.js?v=1"></script>
    <script src="layout.js?v=6.1"></script>
    
    <script>
        const slider = document.getElementById('level-slider');
        const levels = {
            1:  { tag: "Globero", time: "01:25:00", watts: "168W", wkg: "2.4", b: "35%" },
            2:  { tag: "Iniciado", time: "01:15:00", watts: "196W", wkg: "2.8", b: "42%" },
            3:  { tag: "Cicloturista", time: "01:05:00", watts: "224W", wkg: "3.2", b: "50%" },
            4:  { tag: "Entrenado", time: "00:58:00", watts: "252W", wkg: "3.6", b: "58%" },
            5:  { tag: "Amateur C3", time: "00:52:00", watts: "280W", wkg: "4.0", b: "65%" },
            6:  { tag: "Amateur C2", time: "00:48:00", watts: "308W", wkg: "4.4", b: "72%" },
            7:  { tag: "Amateur C1", time: "00:45:00", watts: "336W", wkg: "4.8", b: "79%" },
            8:  { tag: "Elite Nac", time: "00:42:30", watts: "371W", wkg: "5.3", b: "86%" },
            9:  { tag: "Pro Conti", time: "00:41:00", watts: "406W", wkg: "5.8", b: "93%" },
            10: { tag: "World Tour", time: "00:39:50", watts: "445W", wkg: "6.8", b: "100%" }
        };

        function updateComparison() {
            if(!slider) return;
            const d = levels[slider.value];
            document.getElementById('level-tag').innerText = d.tag;
            document.getElementById('amateur-time').innerText = d.time;
            document.getElementById('amateur-watts').innerText = `~${d.watts}`;
            document.getElementById('amateur-wkg').innerText = `${d.wkg} W/kg`;
            document.getElementById('amateur-bar').style.width = d.b;
        }

        async function loadContent() {
            // NOTICIAS
            fetch('/api/news')
                .then(res => res.json())
                .then(news => renderNews(news))
                .catch(e => console.error("Error News:", e));

            // CALENDARIO
            fetch('/api/calendar')
                .then(res => res.json())
                .then(raw => {
                    const races = raw.map(r => ({ ...r, ...(typeof r.details === 'string' ? JSON.parse(r.details || '{}') : r.details || {}) }));
                    renderTimeline(races);
                    renderUpcomingWidget(races);
                }).catch(e => console.error("Error Calendar:", e));

            // RANKING
            fetch('/api/ranking')
                .then(res => {
                    if (!res.ok) throw new Error("Error API");
                    return res.json();
                })
                .then(data => {
                    if (data && data.length > 0) {
                        renderRanking(data);
                    } else {
                        throw new Error("Empty Data"); 
                    }
                })
                .catch(e => {
                    const fallbackData = [
                        { name: "Tadej Pogačar", team: "UAE Team Emirates", points: 7890 },
                        { name: "Jonas Vingegaard", team: "Visma | Lease a Bike", points: 6540 },
                        { name: "Remco Evenepoel", team: "Soudal Quick-Step", points: 5430 },
                        { name: "Mathieu van der Poel", team: "Alpecin-Deceuninck", points: 4890 },
                        { name: "Primož Roglič", team: "Red Bull - BORA", points: 4210 }
                    ];
                    renderRanking(fallbackData);
                });
        }

        // --- NUEVA LÓGICA DE RENDERIZADO DE NOTICIAS ---
        function renderNews(news) {
            const container = document.getElementById('latest-news-container');
            
            if (news && news.length > 0) {
                const n = news[0]; // Noticia principal destacada
                
                // Texto de resumen por defecto si tu API aún no devuelve "excerpt"
                const excerpt = n.excerpt || "Descubre el análisis de datos completo, las métricas clave de rendimiento y el desglose táctico de la jornada.";

                let html = `
                    <article class="group cursor-pointer grid grid-cols-1 md:grid-cols-12 gap-6 items-center transform transition-all active:scale-[0.99] duration-200" onclick="window.location.href='noticias.html?article=${n.id}'">
                        
                        <div class="md:col-span-7 relative w-full aspect-[16/9] rounded-2xl overflow-hidden border border-white/5 bg-zinc-900">
                            <div class="absolute top-4 left-4 z-10">
                                <span class="bg-cyan-500 text-black text-[10px] font-black px-2.5 py-1 rounded uppercase tracking-widest shadow-lg">
                                    ${n.tag || 'Race Report'}
                                </span>
                            </div>
                            <img src="${n.image || 'assets/default-news.jpg'}" alt="Noticia" class="w-full h-full object-cover grayscale opacity-90 transition-all duration-700 group-hover:grayscale-0 group-hover:opacity-100 group-hover:scale-105">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                        </div>

                        <div class="md:col-span-5 flex flex-col justify-center space-y-4 pr-4">
                            <div class="flex items-center gap-3 text-[10px] font-mono text-zinc-500 uppercase tracking-widest">
                                <span>${n.date || 'HOY'}</span>
                                <span class="w-1 h-1 bg-zinc-700 rounded-full"></span>
                                <span>4 MIN READ</span>
                            </div>
                            
                            <h3 class="text-2xl md:text-3xl font-extrabold text-white tracking-tight leading-tight group-hover:text-cyan-400 transition-colors">
                                ${n.title}
                            </h3>
                            
                            <p class="text-sm text-zinc-400 leading-relaxed line-clamp-3">
                                ${excerpt}
                            </p>
                        </div>
                    </article>
                `;

                // Renderiza sub-noticias si la API trae más de 1
                if (news.length > 1) {
                    html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8 pt-6 border-t border-zinc-800/50">`;
                    for(let i = 1; i < Math.min(news.length, 3); i++) {
                        const subNews = news[i];
                        html += `
                            <a href="noticias.html?article=${subNews.id}" class="flex gap-4 items-center group transform transition-all active:scale-[0.98]">
                                <div class="w-20 h-20 md:w-24 md:h-24 flex-shrink-0 rounded-xl overflow-hidden border border-white/5 bg-zinc-900">
                                    <img src="${subNews.image}" class="w-full h-full object-cover grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-500">
                                </div>
                                <div>
                                    <span class="text-cyan-600 text-[9px] font-black uppercase tracking-widest">${subNews.tag || 'Insight'}</span>
                                    <h4 class="text-sm font-bold text-zinc-300 group-hover:text-white leading-tight mt-1 line-clamp-2">${subNews.title}</h4>
                                </div>
                            </a>
                        `;
                    }
                    html += `</div>`;
                }

                container.innerHTML = html;
            } else {
                container.innerHTML = '<p class="text-zinc-600 text-sm text-center py-10 font-mono">No hay datos en el servidor.</p>';
            }
        }

        function renderRanking(data) {
            const container = document.getElementById('ranking-list');
            const sorted = data.sort((a,b) => b.points - a.points).slice(0, 5);
            container.innerHTML = sorted.map((r, i) => `
            <div class="flex items-center justify-between p-3 border-b border-zinc-800/50 last:border-0">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-black text-zinc-600 w-5">${i + 1}</span>
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-white">${r.name}</span>
                        <span class="text-[10px] font-black uppercase text-zinc-600">${r.team}</span>
                    </div>
                </div>
                <div class="text-right">
                    <span class="block text-lg font-black text-amber-500 leading-none">${r.points}</span>
                    <span class="text-[8px] text-zinc-600 uppercase font-black">PTS</span>
                </div>
            </div>`).join('');
        }

        function renderUpcomingWidget(races) {
            const container = document.getElementById('upcoming-races');
            const now = new Date().toISOString().split('T')[0];
            const upcoming = races.filter(r => r.dateISO >= now || r.status === 'Active')
                              .sort((a,b) => a.dateISO.localeCompare(b.dateISO))
                              .slice(0, 3);

            if (upcoming.length > 0) {
                container.innerHTML = upcoming.map(r => `
                    <a href="calendario.html?race=${encodeURIComponent(r.name)}" class="block p-3 bg-black/40 border border-zinc-800 hover:border-zinc-600 rounded-xl transition-all group">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] font-black text-zinc-500 uppercase group-hover:text-zinc-300">${r.date}</span>
                            <span class="text-[9px] font-bold text-yellow-500 bg-yellow-900/20 px-1.5 py-0.5 rounded border border-yellow-900/50">${r.category || 'WT'}</span>
                        </div>
                        <h4 class="text-sm font-bold text-zinc-300 group-hover:text-white truncate">${r.name}</h4>
                    </a>`).join('');
            } else {
                container.innerHTML = '<p class="text-[10px] text-zinc-500 text-center py-4">Sin carreras próximas.</p>';
            }
        }

        // --- LÓGICA DE CALENDARIO MULTI-DÍA Y APILAMIENTO ---
        function renderTimeline(races) {
            const now = new Date();
            const m = now.getMonth();
            const y = now.getFullYear();
            const dToday = now.getDate();
            const monthNames = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
            const fullMonthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            
            // Paleta de colores para cuando coinciden carreras (Stacking)
            const raceColors = [
                { bg: 'bg-yellow-500', shadow: 'shadow-yellow-500/50' },
                { bg: 'bg-cyan-500', shadow: 'shadow-cyan-500/50' },
                { bg: 'bg-pink-500', shadow: 'shadow-pink-500/50' },
                { bg: 'bg-emerald-500', shadow: 'shadow-emerald-500/50' },
                { bg: 'bg-violet-500', shadow: 'shadow-violet-500/50' }
            ];

            document.getElementById('timeline-month-label').innerText = `${fullMonthNames[m]} ${y}`;
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const scrollContainer = document.getElementById('timeline-scroll');
            let html = '';
            
            // 1. Detectar Carreras HOY
            const todayRaces = races.filter(r => {
                const start = new Date(r.dateISO);
                let end = r.endDateISO ? new Date(r.endDateISO) : new Date(r.dateISO);
                const current = new Date(y, m, dToday);
                start.setHours(0,0,0,0); end.setHours(0,0,0,0); current.setHours(0,0,0,0);
                return current >= start && current <= end;
            });

            // 2. Lógica del HEADER (Prioridad: En Curso > Próxima)
            if (todayRaces.length > 0) {
                // HAY CARRERA HOY
                const r = todayRaces[0];
                document.getElementById('timeline-race-name').innerText = r.name;
                document.getElementById('timeline-race-name').classList.add('text-cyan-400'); // Color distintivo para EN CURSO
                document.getElementById('timeline-race-meta').style.opacity = '1';
                
                const badge = document.getElementById('meta-cat');
                badge.innerText = "NOW RACING";
                badge.className = "text-[9px] font-black uppercase text-cyan-400 bg-cyan-900/20 px-1.5 py-0.5 rounded border border-cyan-500/30 animate-pulse";
                
                document.getElementById('meta-link').href = `calendario.html?race=${encodeURIComponent(r.name)}`;

                // Activar barra LIVE
                document.getElementById('live-race-banner').classList.remove('hidden');
                document.getElementById('live-race-name').innerText = r.name;
                document.getElementById('live-race-link').href = `calendario.html?race=${encodeURIComponent(r.name)}`;
            } else {
                // NO HAY CARRERA HOY -> BUSCAR LA SIGUIENTE
                const futureRaces = races.filter(r => {
                    const start = new Date(r.dateISO);
                    const current = new Date(y, m, dToday);
                    start.setHours(0,0,0,0); current.setHours(0,0,0,0);
                    return start > current;
                }).sort((a,b) => a.dateISO.localeCompare(b.dateISO));

                if (futureRaces.length > 0) {
                    const nextR = futureRaces[0];
                    document.getElementById('timeline-race-name').innerText = nextR.name;
                    document.getElementById('timeline-race-name').classList.remove('text-cyan-400');
                    document.getElementById('timeline-race-meta').style.opacity = '1';

                    const badge = document.getElementById('meta-cat');
                    badge.innerText = nextR.category || "NEXT";
                    badge.className = "text-[9px] font-bold uppercase text-yellow-500 bg-yellow-900/30 border border-yellow-500/30 px-1.5 py-0.5 rounded";

                    document.getElementById('meta-link').href = `calendario.html?race=${encodeURIComponent(nextR.name)}`;
                } else {
                    document.getElementById('timeline-race-name').innerText = "Sin carreras";
                }
            }

            // 3. Generar DÍAS del calendario
            for (let d = 1; d <= daysInMonth; d++) {
                const activeRaces = races.filter(r => {
                    const start = new Date(r.dateISO);
                    let end = r.endDateISO ? new Date(r.endDateISO) : new Date(r.dateISO);
                    const current = new Date(y, m, d);
                    start.setHours(0,0,0,0); end.setHours(0,0,0,0); current.setHours(0,0,0,0);
                    return current >= start && current <= end;
                });

                const isToday = d === dToday;
                let dayContent = '';

                if (activeRaces.length > 0) {
                    // APILAMIENTO: Crear una barrita por cada carrera activa
                    const indicators = activeRaces.map((r, index) => {
                        const color = raceColors[index % raceColors.length]; // Rotar colores
                        return `<div class="w-8 h-1 ${color.bg} rounded-full mb-1 shadow-[0_0_5px_currentColor]"></div>`;
                    }).join('');

                    // El enlace va a la primera carrera (prioridad)
                    const mainRace = activeRaces[0];

                    dayContent = `<div class="timeline-day day-active group ${isToday ? 'day-today' : ''}" onclick="window.location.href='calendario.html?race=${encodeURIComponent(mainRace.name)}'">
                                    <span class="day-month">${monthNames[m]}</span>
                                    <span class="day-number">${d}</span>
                                    <div class="flex flex-col items-center mt-1 w-full px-1">
                                        ${indicators}
                                    </div>
                                 </div>`;
                } else {
                    dayContent = `<div class="timeline-day day-empty ${isToday ? 'day-today' : ''}">
                                    <span class="day-number">${d}</span>
                                    <div class="timeline-tick"></div>
                                 </div>`;
                }
                
                html += dayContent;
            }
            
            scrollContainer.innerHTML = html;
            // Scroll automático al día de hoy (con un poco de margen)
            if(dToday > 3) setTimeout(() => { scrollContainer.scrollLeft = (dToday - 3) * 52; }, 100);
        }

        document.addEventListener('DOMContentLoaded', () => {
            updateComparison();
            loadContent();
            if(slider) slider.addEventListener('input', updateComparison);
        });
    </script>
</body>
</html>
