<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="icon" type="image/svg+xml" href="assets/logo-icon.svg">
    
    <title>VELO INSIGHTS | An√°lisis de Datos y Ciclismo WorldTour</title>
    <meta name="description" content="Plataforma l√≠der en an√°lisis de datos, rendimiento, calendario y noticias del ciclismo profesional WorldTour. Compara vatios, rankings y estad√≠sticas clave.">
    <meta name="keywords" content="ciclismo, WorldTour, an√°lisis de datos, vatios, w/kg, Tadej Pogacar, Jonas Vingegaard, calendario ciclista, resultados ciclismo, telemetr√≠a, tech lab">
    <meta name="author" content="Velo Insights">
    <meta name="robots" content="index, follow, max-image-preview:large">
    <link rel="canonical" href="https://veloinsights.es/">
    
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://veloinsights.es/">
    <meta property="og:title" content="VELO INSIGHTS | An√°lisis de Datos y Ciclismo WorldTour">
    <meta property="og:description" content="Plataforma l√≠der en an√°lisis de datos, rendimiento, calendario y noticias del ciclismo profesional. Tu laboratorio de performance.">
    <meta property="og:image" content="https://veloinsights.es/assets/default-news.jpg">

    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://veloinsights.es/">
    <meta name="twitter:title" content="VELO INSIGHTS | An√°lisis de Datos y Ciclismo WorldTour">
    <meta name="twitter:description" content="Plataforma l√≠der en an√°lisis de datos, rendimiento, calendario y noticias del ciclismo profesional. Tu laboratorio de performance.">
    <meta name="twitter:image" content="https://veloinsights.es/assets/default-news.jpg">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#050505">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/main.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <style>
        body { -webkit-tap-highlight-color: transparent; }
        
        .live-dot { width: 6px; height: 6px; background-color: #ef4444; border-radius: 50%; display: inline-block; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .timeline-container {
            background: linear-gradient(180deg, rgba(17, 17, 26, 0.95) 0%, rgba(5,5,5,1) 100%);
            border-top: 1px solid rgba(139, 92, 246, 0.2);
            border-bottom: 1px solid rgba(139, 92, 246, 0.2);
            position: relative; overflow: hidden;
        }
        .mask-linear {
            mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
            -webkit-mask-image: linear-gradient(to right, transparent, black 5%, black 95%, transparent);
        }
        
        .custom-scrollbar::-webkit-scrollbar { display: none; }
        .custom-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .timeline-tick { width: 1px; height: 12px; background-color: #3f3f46; margin: 0 auto; transition: all 0.3s; }
        .timeline-day { flex: 0 0 52px; height: 75px; display: flex; flex-direction: column; justify-content: start; align-items: center; padding-top: 10px; transition: all 0.2s; position: relative; cursor: pointer; }
        
        .day-active { background: rgba(139, 92, 246, 0.05); }
        .day-active .timeline-tick { display: none; } 
        
        .day-number { font-size: 0.9rem; color: #71717a; font-weight: 700; margin-bottom: 4px; transition: color 0.3s; }
        .day-active .day-number { color: #e4e4e7; }
        .day-today .day-number { color: #38bdf8; text-shadow: 0 0 10px rgba(56, 189, 248, 0.5); font-size: 1.1rem; }
        .day-month { display: block; color: #a1a1aa; font-size: 8px; font-weight: 900; text-transform: uppercase; margin-bottom: 2px; }
        .day-empty .day-number { font-size: 0.65rem; color: #52525b; font-weight: 500; margin-bottom: 6px; }

        .comparison-card { background: linear-gradient(180deg, rgba(6, 25, 20, 0.6) 0%, rgba(5,5,5,0.9) 100%); position: relative; overflow: hidden; border: 1px solid rgba(16, 185, 129, 0.15); height: 100%; }
        .stage-profile-bg { 
            position: absolute; bottom: 0; left: 0; width: 100%; height: 70%; 
            background: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 300' preserveAspectRatio='none'%3E%3Cpath d='M0,300 L50,280 L150,250 L300,200 L450,150 L600,100 L750,50 L900,20 L1000,300 Z' fill='rgba(16, 185, 129, 0.05)' /%3E%3Cpath d='M0,300 L50,280 L150,250 L300,200 L450,150 L600,100 L750,50 L900,20 L1000,0' fill='none' stroke='rgba(16, 185, 129, 0.15)' stroke-width='1.5' vector-effect='non-scaling-stroke'/%3E%3C/svg%3E") no-repeat bottom; 
            background-size: cover; pointer-events: none; z-index: 0; 
        }

        input[type=range].slider-green { -webkit-appearance: none; background: #27272a; height: 4px; border-radius: 2px; width: 100%; }
        input[type=range].slider-green::-webkit-slider-thumb { -webkit-appearance: none; height: 20px; width: 20px; border-radius: 50%; background: #10b981; cursor: pointer; border: 2px solid #064e3b; box-shadow: 0 0 10px rgba(16, 185, 129, 0.4); margin-top: -8px; }
        
        .trending-tag { transition: all 0.2s; }
        .trending-tag:hover { background: rgba(34, 211, 238, 0.1); border-color: rgba(34, 211, 238, 0.5); color: #22d3ee; transform: translateY(-2px); }
    </style>
</head>

<body class="bg-[#050505] antialiased overflow-x-hidden selection:bg-cyan-500/30 selection:text-cyan-200 pb-20">

    <div id="live-race-banner" class="hidden fixed bottom-0 left-0 w-full z-[100] bg-gradient-to-r from-red-900/95 to-black border-t border-red-500/30 backdrop-blur-md transition-all shadow-[0_-5px_20px_rgba(220,38,38,0.3)]">
        <div class="max-w-7xl mx-auto px-5 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3 overflow-hidden">
                <span class="flex h-2 w-2 relative flex-shrink-0">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-red-500"></span>
                </span>
                <p class="text-[10px] font-black uppercase text-white tracking-widest truncate">
                    LIVE: <span id="live-race-name" class="text-red-400">--</span>
                </p>
            </div>
            <a href="#" id="live-race-link" class="flex-shrink-0 text-[9px] font-bold uppercase text-white bg-red-600 hover:bg-red-500 transition-colors px-4 py-1.5 rounded-full shadow-lg shadow-red-900/50">Ver</a>
        </div>
    </div>

    <header class="relative pt-32 md:pt-44 pb-10 px-4 text-center">
        <div class="max-w-4xl mx-auto animate-fade-in-up">
            <p class="text-cyan-500 font-bold tracking-[0.2em] text-[9px] uppercase mb-3">VELO INSIGHTS</p>
            <h1 class="text-5xl md:text-8xl font-heading text-white italic uppercase tracking-tighter leading-[0.9] drop-shadow-2xl">
                Data <span class="text-zinc-700">Driven</span><br>Cycling
            </h1>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 md:px-6 space-y-8 md:space-y-10 pb-12">
        
        <section id="race-control-room" class="hidden animate-fade-in-up">
            <div class="flex items-center gap-4 mb-6 border-b border-slate-700/50 pb-4">
                <div class="flex items-center gap-2 px-3 py-1 bg-red-500/10 border border-red-500/30 rounded-full">
                    <span class="w-2.5 h-2.5 rounded-full bg-red-500 animate-pulse"></span>
                    <span class="text-[10px] md:text-xs font-black uppercase tracking-widest text-red-400">RACE CENTER</span>
                </div>
                <h2 id="rcr-name" class="text-xl md:text-3xl font-black text-white italic tracking-tight">Cargando...</h2>
                <span id="rcr-category" class="bg-slate-800 text-slate-300 text-[10px] font-bold px-2 py-1 rounded uppercase tracking-widest ml-auto border border-slate-600">WT</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="col-span-1 bg-gradient-to-br from-slate-900 to-[#050505] rounded-2xl border border-slate-700 shadow-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-emerald-500/5 rounded-full blur-3xl"></div>
                    <p class="text-[10px] font-black uppercase text-slate-500 tracking-widest mb-6"><i class="fas fa-satellite-dish mr-2"></i>Telemetr√≠a</p>
                    
                    <div class="space-y-4 font-mono text-sm">
                        <div class="flex justify-between items-end border-b border-slate-800 pb-2">
                            <span class="text-slate-400">DISTANCIA</span>
                            <span id="rcr-km" class="text-emerald-400 font-bold text-lg">--- km</span>
                        </div>
                        <div class="flex justify-between items-end border-b border-slate-800 pb-2">
                            <span class="text-slate-400">DESNIVEL</span>
                            <span id="rcr-elevation" class="text-cyan-400 font-bold text-lg">--- m</span>
                        </div>
                        <div class="flex justify-between items-end border-b border-slate-800 pb-2">
                            <span class="text-slate-400">TIPO</span>
                            <span id="rcr-type" class="text-white font-bold">---</span>
                        </div>
                    </div>
                </div>

                <div class="col-span-1 lg:col-span-2 bg-gradient-to-br from-amber-950/20 to-[#050505] rounded-2xl border border-amber-500/20 shadow-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-500 to-transparent"></div>
                    <p class="text-[10px] font-black uppercase text-amber-500 tracking-widest mb-6 flex items-center gap-2">
                        <i class="fas fa-bolt"></i> TACTICAL BOARD
                    </p>
                    <div class="prose prose-invert max-w-none text-slate-300 text-sm md:text-base leading-relaxed">
                        <em>(Espacio reservado: Al redactar una noticia sobre esta carrera, copia y pega aqu√≠ tus claves t√°cticas del d√≠a).</em>
                    </div>
                </div>
            </div>
        </section>

        <section>
            <div class="flex justify-between items-baseline mb-6 px-1 border-b border-zinc-800/60 pb-3">
                <h2 class="text-xl font-heading text-white italic uppercase tracking-tight">ULTIMAS <span class="text-cyan-500">NOTICIAS</span></h2>
                <a href="noticias.html" class="text-[10px] font-bold text-zinc-500 hover:text-cyan-400 uppercase tracking-widest transition-colors">Ver Journal ‚Üí</a>
            </div>
            
            <div id="latest-news-container" class="w-full">
                <div class="h-64 bg-zinc-900/50 rounded-2xl animate-pulse flex items-center justify-center border border-zinc-800/50">
                    <span class="text-[10px] text-zinc-600 font-bold uppercase tracking-widest">Conectando con el Lab...</span>
                </div>
            </div>
        </section>

        <section>
            <div class="flex justify-between items-end px-2 mb-3">
                <div class="text-left overflow-hidden">
                    <h2 id="timeline-race-name" class="text-lg font-heading text-white italic uppercase leading-none transition-all truncate pr-2">Cargando...</h2>
                    <div id="timeline-race-meta" class="opacity-0 transition-opacity flex items-center gap-2 text-[9px] font-bold uppercase mt-1">
                        <span id="meta-cat" class="px-1.5 py-0.5 rounded border">--</span>
                        <a id="meta-link" href="#" class="text-zinc-400 hover:text-white underline decoration-zinc-700">Ficha T√©cnica</a>
                    </div>
                </div>
                <span id="timeline-month-label" class="text-[9px] font-black text-zinc-600 uppercase tracking-widest whitespace-nowrap">--</span>
            </div>
            <div class="timeline-container rounded-xl shadow-2xl shadow-violet-900/10">
                <div id="timeline-scroll" class="flex overflow-x-auto custom-scrollbar pb-0 cursor-grab active:cursor-grabbing select-none py-2 px-4 mask-linear">
                </div>
            </div>
        </section>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8 items-stretch">
            
            <aside class="bg-zinc-900/30 border border-zinc-800 rounded-2xl p-5 flex flex-col">
                <h3 class="text-base font-heading text-white italic uppercase mb-4 border-b border-zinc-800 pb-2">PROXIMAS <span class="text-yellow-500">CARRERAS</span></h3>
                <div id="upcoming-races" class="space-y-2 flex-1 flex flex-col justify-start">
                    <p class="text-[10px] text-zinc-500 text-center py-4 tracking-widest uppercase animate-pulse">Sincronizando fechas...</p>
                </div>
            </aside>

            <aside class="bg-zinc-900/30 border border-zinc-800 rounded-2xl p-5 backdrop-blur-sm flex flex-col">
                <div class="flex justify-between items-end mb-4 border-b border-zinc-800 pb-2">
                    <h3 class="text-base font-heading text-white italic uppercase">UCI <span class="text-amber-500">RANKING</span></h3>
                    <a href="ranking.html" class="text-[9px] font-bold text-zinc-600 hover:text-amber-500 uppercase transition-colors">TOP 5</a>
                </div>
                <div id="ranking-list" class="space-y-1 flex-1 flex flex-col justify-start">
                    <p class="text-[10px] text-zinc-500 text-center py-4 tracking-widest uppercase animate-pulse">Obteniendo puntos...</p>
                </div>
            </aside>

        </div>

        <section class="grid grid-cols-1 lg:grid-cols-5 gap-6 md:gap-8 items-stretch">
            
            <div class="lg:col-span-3">
                <div class="comparison-card rounded-2xl p-5 md:p-8 opacity-90 hover:opacity-100 transition-opacity flex flex-col justify-between">
                    <div class="stage-profile-bg"></div>

                    <div class="relative z-10 w-full mb-8">
                        <div class="flex justify-between items-start mb-6">
                            <div>
                                <h3 class="text-sm font-heading text-white italic uppercase flex items-center gap-2">
                                    Pro vs Amateur 
                                    <span id="sync-badge" class="hidden bg-emerald-500/20 text-emerald-400 border border-emerald-500/30 text-[8px] px-1.5 py-0.5 rounded uppercase tracking-widest">Tech Lab Sync ON</span>
                                </h3>
                                <p class="text-[9px] text-zinc-500">Ref: Alpe d'Huez (13.8km @ 8.1%)</p>
                            </div>
                            <div id="level-tag" class="text-emerald-400 text-[10px] font-black uppercase tracking-widest backdrop-blur-sm bg-black/40 border border-emerald-500/30 px-3 py-1 rounded">--</div>
                        </div>

                        <div class="mb-6 border-l-2 border-zinc-700 pl-3">
                            <div class="flex justify-between items-center mb-1">
                                <span class="text-[9px] font-bold uppercase text-zinc-400">Tadej Pogaƒçar</span>
                                <span class="text-xs font-mono text-white font-bold">39' 50"</span>
                            </div>
                            <div class="flex justify-between text-[9px] font-mono text-zinc-500">
                                <span>~445 Watts</span>
                                <span>6.8 W/kg</span>
                            </div>
                            <div class="h-1 bg-zinc-800 rounded-full mt-2 overflow-hidden w-full">
                                <div class="h-full bg-white w-full shadow-[0_0_10px_white]"></div>
                            </div>
                        </div>

                        <div class="mb-4 border-l-2 border-emerald-500 pl-3">
                            <div class="flex justify-between items-center mb-1">
                                <span id="amateur-label" class="text-[9px] font-bold uppercase text-emerald-500">Tu Nivel Estimado</span>
                                <span id="amateur-time" class="text-xs font-mono text-white font-bold">--</span>
                            </div>
                            <div class="flex justify-between text-[9px] font-mono text-emerald-400/80">
                                <span id="amateur-watts">-- Watts</span>
                                <span id="amateur-wkg">-- W/kg</span>
                            </div>
                            <div class="h-1 bg-zinc-800 rounded-full mt-2 overflow-hidden w-full">
                                <div id="amateur-bar" class="h-full bg-emerald-500 w-[50%] shadow-[0_0_10px_#10b981] transition-all duration-500"></div>
                            </div>
                        </div>
                    </div>

                    <div id="slider-container" class="pt-2 relative z-10 w-full mt-auto">
                        <input type="range" min="1" max="10" value="4" class="slider-green w-full block" id="level-slider" aria-label="Ajustar nivel ciclista">
                        <div class="flex justify-between text-[8px] font-bold text-zinc-600 uppercase mt-2 tracking-widest">
                            <span>Globero</span><span>World Tour</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 flex flex-col gap-6">
                <div class="bg-zinc-900/40 border border-zinc-800 rounded-2xl p-5 shadow-inner">
                    <h3 class="text-[10px] font-black text-white uppercase tracking-widest mb-4 flex items-center gap-2">
                        <span class="w-1.5 h-1.5 rounded-full bg-zinc-300"></span>
                        Estado de Forma
                    </h3>
                    <div id="trending-riders-container" class="space-y-3">
                        <p class="text-[10px] text-zinc-500 uppercase tracking-widest animate-pulse">Calculando mercado...</p>
                    </div>
                </div>

                <div class="bg-zinc-900/40 border border-zinc-800 rounded-2xl p-5 shadow-inner">
                    <h3 class="text-[10px] font-black text-white uppercase tracking-widest mb-4 flex items-center gap-2">
                        <svg class="w-3 h-3 text-cyan-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 20l4-16m2 16l4-16M6 9h14M4 15h14"></path></svg>
                        Hot Topics
                    </h3>
                    <div id="hot-topics-container" class="flex flex-wrap gap-2">
                        <p class="text-[10px] text-zinc-500 uppercase tracking-widest animate-pulse">Analizando t√©rminos...</p>
                    </div>
                </div>

                <a href="calculadora.html" class="mt-auto group relative bg-gradient-to-br from-cyan-950/30 to-[#050505] border border-cyan-900/50 rounded-2xl p-5 overflow-hidden transition-all duration-300 hover:border-cyan-500/50 hover:shadow-[0_0_20px_rgba(6,182,212,0.15)] flex flex-col items-center text-center">
                    <div class="w-10 h-10 bg-cyan-900/30 rounded-full flex items-center justify-center mb-3 border border-cyan-500/30 group-hover:bg-cyan-500 group-hover:border-cyan-400 transition-colors">
                        <i class="fas fa-cogs text-cyan-400 group-hover:text-black text-lg transition-colors"></i>
                    </div>
                    <h3 class="text-sm font-black text-white uppercase tracking-widest mb-1 group-hover:text-cyan-400 transition-colors">Calculadora Transmisi√≥n</h3>
                    <p class="text-[10px] text-zinc-400 font-mono mb-4 leading-relaxed">Simula desarrollos, ratios, y velocidad vs cadencia en tiempo real.</p>
                    <span class="text-[9px] font-bold bg-cyan-900/40 text-cyan-400 px-4 py-2 rounded-full border border-cyan-500/30 uppercase tracking-widest group-hover:bg-cyan-500 group-hover:text-black transition-colors w-full">
                        Abrir Tech Lab &rarr;
                    </span>
                </a>
            </div>
        </section>

        <section class="w-full mt-4">
            <div class="bg-gradient-to-r from-zinc-900/80 to-[#050505] border border-zinc-800 backdrop-blur-md rounded-2xl p-6 md:p-8 relative overflow-hidden group shadow-2xl flex flex-col md:flex-row items-center gap-6 justify-between w-full">
                <div class="absolute top-0 left-0 w-64 h-64 bg-cyan-500/5 rounded-full blur-3xl pointer-events-none group-hover:bg-cyan-500/10 transition-colors duration-700"></div>
                
                <div class="flex-1 w-full relative z-10">
                    <div class="flex items-center gap-2 mb-3">
                        <span class="w-2 h-2 rounded-full bg-cyan-500 animate-pulse shadow-[0_0_8px_#06b6d4]"></span>
                        <span class="text-[10px] font-black uppercase text-cyan-500 tracking-widest">Dato Destacado ‚Ä¢ Tech Lab</span>
                    </div>
                    <p id="ranking-insight-text" class="text-sm md:text-base text-zinc-300 italic leading-relaxed font-medium">Cargando m√©tricas de rendimiento desde la base de datos central...</p>
                </div>
                
                <div class="shrink-0 w-full md:w-auto text-left md:text-right relative z-10 mt-2 md:mt-0">
                    <a href="glosario.html" class="inline-flex justify-center items-center gap-3 text-[10px] font-black text-black bg-cyan-500 hover:bg-cyan-400 px-6 py-3.5 rounded-xl uppercase tracking-[0.2em] transition-transform hover:-translate-y-1 hover:shadow-[0_10px_20px_rgba(34,211,238,0.3)] w-full md:w-auto">
                        Explorar Glosario <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7-7m7-7H3"></path></svg>
                    </a>
                </div>
            </div>
        </section>

    </main>
    
    <script src="renderers.js?v=1"></script>
    <script src="layout.js?v=6.1"></script>
    
    <script>
        const slider = document.getElementById('level-slider');
        const sliderContainer = document.getElementById('slider-container');
        const syncBadge = document.getElementById('sync-badge');
        
        const levels = {
            1:  { tag: "Globero", time: "01:25:00", watts: "168W", wkg: "2.4", b: "35%" },
            2:  { tag: "Iniciado", time: "01:15:00", watts: "196W", wkg: "2.8", b: "42%" },
            3:  { tag: "Cicloturista", time: "01:05:00", watts: "224W", wkg: "3.2", b: "50%" },
            4:  { tag: "Entrenado", time: "00:58:00", watts: "252W", wkg: "3.6", b: "58%" },
            5:  { tag: "Amateur C3", time: "00:52:00", watts: "280W", wkg: "4.0", b: "65%" },
            6:  { tag: "Amateur C2", time: "00:48:00", watts: "308W", wkg: "4.4", b: "72%" },
            7:  { tag: "Amateur C1", time: "00:45:00", watts: "336W", wkg: "4.8", b: "79%" },
            8:  { tag: "Elite Nac", time: "00:42:30", watts: "371W", wkg: "5.3", b: "86%" },
            9:  { tag: "Pro Conti", time: "00:41:00", watts: "406W", wkg: "5.8", b: "93%" },
            10: { tag: "World Tour", time: "00:39:50", watts: "445W", wkg: "6.8", b: "100%" }
        };

        function initComparisonEngine() {
            const savedWatts = localStorage.getItem('velo_watts');
            const savedWeight = localStorage.getItem('velo_weight');

            if (savedWatts && savedWeight) {
                const w = parseFloat(savedWatts);
                const kg = parseFloat(savedWeight);
                const wkg = (w / kg).toFixed(2);
                
                const factorAlpe = 248;
                const minutes = (factorAlpe / wkg).toFixed(0);
                const timeString = `${Math.floor(minutes/60)}h ${minutes%60}m`;
                
                let t = "Globero";
                if(wkg >= 6.2) t = "Pro Conti";
                else if (wkg >= 5.0) t = "Elite Nacional";
                else if (wkg >= 4.0) t = "Amateur";
                else if (wkg >= 3.0) t = "Cicloturista";

                const percentage = Math.min(100, Math.max(20, (wkg / 6.8) * 100));

                document.getElementById('level-tag').innerText = t;
                document.getElementById('amateur-time').innerText = timeString;
                document.getElementById('amateur-watts').innerText = `~${w} W`;
                document.getElementById('amateur-wkg').innerText = `${wkg} W/kg`;
                document.getElementById('amateur-bar').style.width = `${percentage}%`;
                
                document.getElementById('amateur-label').innerText = "Tus Datos (Tech Lab)";
                
                sliderContainer.classList.add('hidden');
                syncBadge.classList.remove('hidden');
            } else {
                updateComparisonSlider();
                if(slider) slider.addEventListener('input', updateComparisonSlider);
            }
        }

        function updateComparisonSlider() {
            if(!slider) return;
            const d = levels[slider.value];
            document.getElementById('level-tag').innerText = d.tag;
            document.getElementById('amateur-time').innerText = d.time;
            document.getElementById('amateur-watts').innerText = `~${d.watts}`;
            document.getElementById('amateur-wkg').innerText = `${d.wkg} W/kg`;
            document.getElementById('amateur-bar').style.width = d.b;
        }

        function renderRaceControlRoom(races) {
            const liveRace = races.find(r => r.status === 'Live');
            if (liveRace) {
                document.getElementById('race-control-room').classList.remove('hidden');
                document.getElementById('rcr-name').innerText = liveRace.name;
                document.getElementById('rcr-category').innerText = liveRace.category || 'WT';
                
                try {
                    let details = liveRace;
                    if (liveRace.details && typeof liveRace.details === 'string' && liveRace.details.trim().startsWith('{')) {
                        details = JSON.parse(liveRace.details);
                    }

                    if (details.stages && details.stages.length > 0) {
                        const etapa1 = details.stages[0];
                        document.getElementById('rcr-km').innerText = (etapa1.km || '---') + ' km';
                        document.getElementById('rcr-elevation').innerText = (etapa1.gain || '---') + ' m+';
                        document.getElementById('rcr-type').innerText = etapa1.type || '---';
                    }

                    if (details.tactical) {
                        const tacticalContainer = document.querySelector('#race-control-room .prose');
                        if (tacticalContainer) {
                            tacticalContainer.innerHTML = `<div class="text-slate-300 text-sm md:text-base leading-relaxed">${details.tactical}</div>`;
                        }
                    }
                } catch(e) {
                    console.log("Detalles t√©cnicos de la carrera no disponibles.", e);
                }
            }
        }

        async function loadContent() {
            const [newsRes, calRes, teamsRes, glosRes, rankRes, trendRes] = await Promise.all([
                fetch('/api/news').then(r => r.ok ? r.json() : []).catch(() => []),
                fetch('/api/calendar').then(r => r.ok ? r.json() : []).catch(() => []),
                fetch('/api/teams').then(r => r.ok ? r.json() : []).catch(() => []),
                fetch('/api/glossary').then(r => r.ok ? r.json() : []).catch(() => []),
                fetch('/api/ranking').then(r => r.ok ? r.json() : []).catch(() => []),
                fetch('/api/trending').then(r => r.ok ? r.json() : []).catch(() => [])
            ]);

            renderNews(newsRes);
            
            const insightCard = document.getElementById('ranking-insight-text');
            if (glosRes && glosRes.length > 0) {
                const itemsWithInsight = glosRes.filter(g => g.insight && g.insight.length > 5);
                if (itemsWithInsight.length > 0) {
                    const selected = itemsWithInsight[Math.floor(Math.random() * itemsWithInsight.length)];
                    insightCard.innerHTML = `<strong class="text-white">${selected.term}:</strong> ${selected.insight}`;
                } else {
                    insightCard.innerHTML = "Actualizando base de datos t√©cnica para la temporada 2026. Revisando m√©tricas...";
                }
            }

            const topicsMap = new Map();
            let riders = [];
            
            if (trendRes && trendRes.length > 0) {
                trendRes.filter(t => t.tipo.toLowerCase() === 'ciclista').forEach(r => {
                    riders.push({ 
                        name: r.title, 
                        team: r.subtitle || 'WorldTour', 
                        value: r.value || '+UP', 
                        manual: true, 
                        mentions: 0 
                    });
                });

                trendRes.filter(t => t.tipo.toLowerCase() === 'topic').forEach(t => {
                    topicsMap.set(t.title, { text: t.title, link: t.subtitle || 'noticias.html', score: 20 });
                });
            }

            const recentNews = newsRes.slice(0, 5);
            const textToScan = recentNews.map(n => (n.title + " " + (n.lead || n.excerpt || "")).toLowerCase()).join(' ');

            if (textToScan.length > 0) {
                recentNews.forEach(n => {
                    if (n.tag) {
                        const tagStr = '#' + n.tag.replace(/\s+/g, '');
                        if(!topicsMap.has(tagStr)) topicsMap.set(tagStr, { text: tagStr, link: 'noticias.html', score: 10 });
                    }
                });

                calRes.forEach(r => {
                    if (textToScan.includes(r.name.toLowerCase())) {
                        const tagStr = '#' + r.name.replace(/\s+/g, '');
                        if(!topicsMap.has(tagStr)) topicsMap.set(tagStr, { text: tagStr, link: `calendario.html?race=${encodeURIComponent(r.name)}`, score: 5 });
                    }
                });

                const allRiders = [];
                teamsRes.forEach(team => {
                    let rList = [];
                    try { rList = typeof team.riders === 'string' ? JSON.parse(team.riders) : team.riders; } catch(e){}
                    rList.forEach(r => allRiders.push({ name: r.name, team: team.name, jersey: team.jersey }));
                });

                allRiders.forEach(pro => {
                    const regex = new RegExp(`\\b${pro.name.toLowerCase()}\\b`, 'g');
                    const match = textToScan.match(regex);
                    
                    if (match && match.length > 0) {
                        if (!riders.find(r => r.name.toLowerCase() === pro.name.toLowerCase())) {
                            riders.push({
                                name: pro.name,
                                team: pro.team,
                                jersey: pro.jersey,
                                value: '+TREND',
                                manual: false,
                                mentions: match.length
                            });
                        }
                    }
                });
            }

            const finalTopics = Array.from(topicsMap.values()).sort((a,b) => b.score - a.score).slice(0, 6);
            if(finalTopics.length > 0) {
                document.getElementById('hot-topics-container').innerHTML = finalTopics.map(t => 
                    `<a href="${t.link}" class="trending-tag px-3 py-1.5 bg-zinc-800/80 text-zinc-300 text-[10px] font-mono rounded-full border border-zinc-700 shadow-sm">${t.text}</a>`
                ).join('');
            } else {
                document.getElementById('hot-topics-container').innerHTML = `<p class="text-[10px] text-zinc-500 italic">Analizando temporada...</p>`;
            }

            riders.sort((a, b) => {
                if (a.manual && !b.manual) return -1;
                if (!a.manual && b.manual) return 1;
                return b.mentions - a.mentions;
            });

            const finalRiders = riders.slice(0, 3);
            
            if(finalRiders.length > 0) {
                document.getElementById('trending-riders-container').innerHTML = finalRiders.map(r => {
                    let jerseyHTML = `<div class="w-14 h-14 shrink-0 rounded-full bg-zinc-800 flex items-center justify-center text-xl border border-zinc-700 shadow-inner group-hover:border-cyan-500/50 transition-colors">üö¥‚Äç‚ôÇÔ∏è</div>`;
                    
                    if (teamsRes && teamsRes.length > 0) {
                        const matchedTeam = teamsRes.find(t => 
                            t.name.toLowerCase().includes(r.team.toLowerCase()) || 
                            r.team.toLowerCase().includes(t.name.toLowerCase()) ||
                            t.code.toLowerCase() === r.team.toLowerCase()
                        );
                        if (matchedTeam && matchedTeam.jersey) {
                            jerseyHTML = `<img src="${matchedTeam.jersey}" alt="Maillot ${r.team}" class="w-14 h-14 shrink-0 object-contain drop-shadow-md transition-transform duration-300 group-hover:scale-110">`;
                        } else if (r.jersey) {
                            jerseyHTML = `<img src="${r.jersey}" alt="Maillot" class="w-14 h-14 shrink-0 object-contain drop-shadow-md transition-transform duration-300 group-hover:scale-110">`;
                        }
                    }

                    const isNegative = r.value && (r.value.includes('-') || r.value.toLowerCase().includes('baja') || r.value.toLowerCase().includes('down'));
                    const textColor = isNegative ? 'text-red-500' : 'text-emerald-400';
                    const icon = isNegative 
                        ? `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M19 14l-7 7m0 0l-7-7m7 7V3"></path></svg>`
                        : `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 10l7-7m0 0l7 7m-7-7v18"></path></svg>`;

                    const cleanValue = r.value.replace(/[\+\-]/g, '').trim() || 'TREND';
                    const subtext = r.manual ? 'DATA' : `${r.mentions} MENCI√ìN${r.mentions > 1 ? 'ES' : ''}`;

                    return `
                    <a href="noticias.html" class="flex justify-between items-center p-2 hover:bg-white/5 rounded-xl transition-colors border border-transparent hover:border-zinc-700/50 group">
                        <div class="flex items-center gap-4">
                            ${jerseyHTML}
                            <div>
                                <p class="text-[15px] font-bold text-white group-hover:text-cyan-400 transition-colors leading-tight">${r.name}</p>
                                <p class="text-[9px] text-zinc-500 font-mono truncate max-w-[120px] mt-0.5">${r.team}</p>
                            </div>
                        </div>
                        <div class="text-right shrink-0">
                            <span class="flex items-center justify-end gap-1 ${textColor} text-xs font-bold font-mono">
                                ${icon}
                                ${cleanValue}
                            </span>
                            <span class="text-[8px] text-zinc-600 uppercase tracking-widest">${subtext}</span>
                        </div>
                    </a>
                    `;
                }).join('');
            } else {
                document.getElementById('trending-riders-container').innerHTML = `<p class="text-[10px] text-zinc-500 italic">Esperando resultados...</p>`;
            }

            const races = calRes.map(r => ({ ...r, ...(typeof r.details === 'string' ? JSON.parse(r.details || '{}') : r.details || {}) }));
            
            renderRaceControlRoom(races);
            renderTimeline(races);
            renderUpcomingWidget(races);

            if(rankRes && rankRes.length > 0) renderRanking(rankRes);
            else renderRanking([{ name: "A√±ade ciclistas", team: "en tu panel Admin", points: 0 }]);
        }

        function renderNews(news) {
            const container = document.getElementById('latest-news-container');
            if (news && news.length > 0) {
                const n = news[0]; 
                const excerpt = n.excerpt || n.lead || "Descubre el an√°lisis de datos completo, las m√©tricas clave de rendimiento y el desglose t√°ctico de la jornada.";

                let html = `
                    <article class="group cursor-pointer grid grid-cols-1 md:grid-cols-12 gap-6 items-center transform transition-all active:scale-[0.99] duration-200" onclick="window.location.href='noticias.html?article=${n.id}'">
                        <div class="md:col-span-7 relative w-full aspect-[16/9] rounded-2xl overflow-hidden border border-white/5 bg-zinc-900">
                            <div class="absolute top-4 left-4 z-10">
                                <span class="bg-cyan-500 text-black text-[10px] font-black px-2.5 py-1 rounded uppercase tracking-widest shadow-lg">${n.tag || 'Race Report'}</span>
                            </div>
                            <img src="${n.image || 'assets/default-news.jpg'}" alt="${n.title}" class="w-full h-full object-cover grayscale opacity-90 transition-all duration-700 group-hover:grayscale-0 group-hover:opacity-100 group-hover:scale-105">
                            <div class="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-transparent"></div>
                        </div>

                        <div class="md:col-span-5 flex flex-col justify-center space-y-4 pr-4">
                            <div class="flex items-center gap-3 text-[10px] font-mono text-zinc-500 uppercase tracking-widest">
                                <span>${n.date || 'HOY'}</span><span class="w-1 h-1 bg-zinc-700 rounded-full"></span><span>4 MIN READ</span>
                            </div>
                            <h3 class="text-2xl md:text-3xl font-extrabold text-white tracking-tight leading-tight group-hover:text-cyan-400 transition-colors">${n.title}</h3>
                            <p class="text-sm text-zinc-400 leading-relaxed line-clamp-3">${excerpt}</p>
                        </div>
                    </article>`;

                if (news.length > 1) {
                    html += `<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-8 pt-6 border-t border-zinc-800/50">`;
                    for(let i = 1; i < Math.min(news.length, 3); i++) {
                        const subNews = news[i];
                        html += `
                            <a href="noticias.html?article=${subNews.id}" class="flex gap-4 items-center group transform transition-all active:scale-[0.98]">
                                <div class="w-20 h-20 md:w-24 md:h-24 flex-shrink-0 rounded-xl overflow-hidden border border-white/5 bg-zinc-900">
                                    <img src="${subNews.image}" alt="${subNews.title}" class="w-full h-full object-cover grayscale opacity-80 group-hover:grayscale-0 group-hover:opacity-100 transition-all duration-500">
                                </div>
                                <div>
                                    <span class="text-cyan-600 text-[9px] font-black uppercase tracking-widest">${subNews.tag || 'Insight'}</span>
                                    <h4 class="text-sm font-bold text-zinc-300 group-hover:text-white leading-tight mt-1 line-clamp-2">${subNews.title}</h4>
                                </div>
                            </a>`;
                    }
                    html += `</div>`;
                }
                container.innerHTML = html;
            } else { container.innerHTML = '<p class="text-zinc-600 text-sm text-center py-10 font-mono">No hay datos en el servidor.</p>'; }
        }

        function renderRanking(data) {
            const container = document.getElementById('ranking-list');
            const sorted = data.sort((a,b) => b.points - a.points).slice(0, 5);
            container.innerHTML = sorted.map((r, i) => `
            <div class="flex items-center justify-between p-3 border-b border-zinc-800/50 last:border-0 group hover:bg-white/5 transition-colors rounded-xl">
                <div class="flex items-center gap-4">
                    <span class="text-sm font-black text-zinc-600 group-hover:text-amber-500 transition-colors w-5">${i + 1}</span>
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-white group-hover:text-amber-400 transition-colors">${r.name}</span>
                        <span class="text-[10px] font-black uppercase text-zinc-600">${r.team}</span>
                    </div>
                </div>
                <div class="text-right pr-2">
                    <span class="block text-lg font-black text-amber-500 leading-none">${r.points}</span>
                    <span class="text-[8px] text-zinc-600 uppercase font-black">PTS</span>
                </div>
            </div>`).join('');
        }

        function renderUpcomingWidget(races) {
            const container = document.getElementById('upcoming-races');
            const now = new Date().toISOString().split('T')[0];
            const upcoming = races.filter(r => r.dateISO >= now || r.status === 'Active').sort((a,b) => a.dateISO.localeCompare(b.dateISO)).slice(0, 3);
            if (upcoming.length > 0) {
                container.innerHTML = upcoming.map(r => `
                    <a href="calendario.html?race=${encodeURIComponent(r.name)}" class="block p-3 bg-black/40 border border-zinc-800 hover:border-zinc-600 rounded-xl transition-all group">
                        <div class="flex justify-between items-center mb-1">
                            <span class="text-[9px] font-black text-zinc-500 uppercase group-hover:text-zinc-300">${r.date}</span>
                            <span class="text-[9px] font-bold text-yellow-500 bg-yellow-900/20 px-1.5 py-0.5 rounded border border-yellow-900/50">${r.category || 'WT'}</span>
                        </div>
                        <h4 class="text-sm font-bold text-zinc-300 group-hover:text-white truncate">${r.name}</h4>
                    </a>`).join('');
            } else { container.innerHTML = '<p class="text-[10px] text-zinc-500 text-center py-4">Sin carreras pr√≥ximas.</p>'; }
        }

        function renderTimeline(races) {
            const now = new Date();
            const m = now.getMonth(); const y = now.getFullYear(); const dToday = now.getDate();
            const monthNames = ["ENE", "FEB", "MAR", "ABR", "MAY", "JUN", "JUL", "AGO", "SEP", "OCT", "NOV", "DIC"];
            const fullMonthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const raceColors = [ { bg: 'bg-yellow-500' }, { bg: 'bg-cyan-500' }, { bg: 'bg-pink-500' }, { bg: 'bg-emerald-500' }, { bg: 'bg-violet-500' } ];

            document.getElementById('timeline-month-label').innerText = `${fullMonthNames[m]} ${y}`;
            const daysInMonth = new Date(y, m + 1, 0).getDate();
            const scrollContainer = document.getElementById('timeline-scroll');
            let html = '';
            
            const todayRaces = races.filter(r => {
                const start = new Date(r.dateISO); let end = r.endDateISO ? new Date(r.endDateISO) : new Date(r.dateISO); const current = new Date(y, m, dToday);
                start.setHours(0,0,0,0); end.setHours(0,0,0,0); current.setHours(0,0,0,0); return current >= start && current <= end;
            });

            if (todayRaces.length > 0) {
                const r = todayRaces[0];
                document.getElementById('timeline-race-name').innerText = r.name; document.getElementById('timeline-race-name').classList.add('text-cyan-400'); document.getElementById('timeline-race-meta').style.opacity = '1';
                const badge = document.getElementById('meta-cat'); badge.innerText = "NOW RACING"; badge.className = "text-[9px] font-black uppercase text-cyan-400 bg-cyan-900/20 px-1.5 py-0.5 rounded border border-cyan-500/30 animate-pulse";
                document.getElementById('meta-link').href = `calendario.html?race=${encodeURIComponent(r.name)}`;
                document.getElementById('live-race-banner').classList.remove('hidden'); document.getElementById('live-race-name').innerText = r.name; document.getElementById('live-race-link').href = `calendario.html?race=${encodeURIComponent(r.name)}`;
            } else {
                const futureRaces = races.filter(r => {
                    const start = new Date(r.dateISO); const current = new Date(y, m, dToday);
                    start.setHours(0,0,0,0); current.setHours(0,0,0,0); return start > current;
                }).sort((a,b) => a.dateISO.localeCompare(b.dateISO));

                if (futureRaces.length > 0) {
                    const nextR = futureRaces[0];
                    document.getElementById('timeline-race-name').innerText = nextR.name; document.getElementById('timeline-race-name').classList.remove('text-cyan-400'); document.getElementById('timeline-race-meta').style.opacity = '1';
                    const badge = document.getElementById('meta-cat'); badge.innerText = nextR.category || "NEXT"; badge.className = "text-[9px] font-bold uppercase text-yellow-500 bg-yellow-900/30 border border-yellow-500/30 px-1.5 py-0.5 rounded";
                    document.getElementById('meta-link').href = `calendario.html?race=${encodeURIComponent(nextR.name)}`;
                } else { document.getElementById('timeline-race-name').innerText = "Sin carreras"; }
            }

            for (let d = 1; d <= daysInMonth; d++) {
                const activeRaces = races.filter(r => {
                    const start = new Date(r.dateISO); let end = r.endDateISO ? new Date(r.endDateISO) : new Date(r.dateISO); const current = new Date(y, m, d);
                    start.setHours(0,0,0,0); end.setHours(0,0,0,0); current.setHours(0,0,0,0); return current >= start && current <= end;
                });
                const isToday = d === dToday;
                if (activeRaces.length > 0) {
                    const indicators = activeRaces.map((r, index) => `<div class="w-8 h-1 ${raceColors[index % raceColors.length].bg} rounded-full mb-1 shadow-[0_0_5px_currentColor]"></div>`).join('');
                    html += `<div class="timeline-day day-active group ${isToday ? 'day-today' : ''}" onclick="window.location.href='calendario.html?race=${encodeURIComponent(activeRaces[0].name)}'"><span class="day-month">${monthNames[m]}</span><span class="day-number">${d}</span><div class="flex flex-col items-center mt-1 w-full px-1">${indicators}</div></div>`;
                } else {
                    html += `<div class="timeline-day day-empty ${isToday ? 'day-today' : ''}"><span class="day-number">${d}</span><div class="timeline-tick"></div></div>`;
                }
            }
            scrollContainer.innerHTML = html;
            if(dToday > 3) setTimeout(() => { scrollContainer.scrollLeft = (dToday - 3) * 52; }, 100);
        }

        document.addEventListener('DOMContentLoaded', () => {
            initComparisonEngine();
            loadContent(); 
        });
    </script>

    <div id="cookie-banner" class="hidden fixed bottom-4 left-4 right-4 md:left-auto md:right-8 md:bottom-8 md:w-[400px] bg-zinc-900/95 backdrop-blur-md border border-zinc-700 shadow-2xl rounded-2xl p-6 z-[999] transform transition-transform duration-500 translate-y-full">
        <div class="flex items-center gap-3 mb-3">
            <i class="fas fa-shield-alt text-cyan-500 text-xl"></i>
            <h3 class="text-white font-black uppercase tracking-widest text-sm">Privacidad y Telemetr√≠a</h3>
        </div>
        <p class="text-zinc-400 text-xs leading-relaxed mb-5 font-mono">
            En Velo Insights utilizamos cookies propias y de terceros para medir el rendimiento de la web (telemetr√≠a) y ofrecerte la mejor experiencia. 
            <a href="privacidad.html" class="text-cyan-400 hover:text-cyan-300 underline decoration-cyan-500/30">Leer pol√≠tica completa</a>.
        </p>
        <div class="flex flex-col sm:flex-row gap-3">
            <button id="btn-accept-cookies" class="flex-1 bg-cyan-600 hover:bg-cyan-500 text-white text-[10px] font-black uppercase tracking-widest py-2.5 rounded-xl transition-colors shadow-[0_0_15px_rgba(6,182,212,0.3)]">
                Aceptar Todas
            </button>
            <button id="btn-reject-cookies" class="flex-1 bg-zinc-800 hover:bg-zinc-700 text-zinc-300 text-[10px] font-bold uppercase tracking-widest py-2.5 rounded-xl border border-zinc-700 transition-colors">
                Solo Esenciales
            </button>
        </div>
    </div>

    <script>
        // L√≥gica del Banner de Cookies
        document.addEventListener('DOMContentLoaded', () => {
            const banner = document.getElementById('cookie-banner');
            const btnAccept = document.getElementById('btn-accept-cookies');
            const btnReject = document.getElementById('btn-reject-cookies');

            // Comprobar si ya tom√≥ una decisi√≥n antes
            if (!localStorage.getItem('velo_cookies_consent')) {
                // Si no hay registro, mostramos el banner con una peque√±a animaci√≥n
                banner.classList.remove('hidden');
                setTimeout(() => {
                    banner.classList.remove('translate-y-full');
                }, 100);
            }

            // Funci√≥n para guardar y ocultar
            const hideBanner = (decision) => {
                localStorage.setItem('velo_cookies_consent', decision);
                banner.classList.add('translate-y-full');
                setTimeout(() => {
                    banner.classList.add('hidden');
                }, 500);
            };

            if(btnAccept) btnAccept.addEventListener('click', () => hideBanner('accepted'));
            if(btnReject) btnReject.addEventListener('click', () => hideBanner('rejected'));
        });
    </script>

</body>
</html>
