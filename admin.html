<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Velo Admin - Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilos oscuros para modo hacker */
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .input-dark { background: #1e293b; border: 1px solid #334155; color: white; width: 100%; padding: 8px; margin-bottom: 10px; rounded: 4px; }
    </style>
</head>
<body class="p-6">

    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-bold text-emerald-400 tracking-tighter">‚ö° VELO ADMIN</h1>
        <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300 uppercase font-bold">Cerrar Sesi√≥n</button>
    </div>

    <div class="flex gap-4 mb-8 overflow-x-auto pb-2">
        <button onclick="loadTable('noticias')" class="px-4 py-2 bg-slate-800 hover:bg-emerald-600 rounded-lg transition border border-slate-700">üì∞ Noticias</button>
        <button onclick="loadTable('calendario')" class="px-4 py-2 bg-slate-800 hover:bg-emerald-600 rounded-lg transition border border-slate-700">üìÖ Calendario</button>
        <button onclick="loadTable('equipos')" class="px-4 py-2 bg-slate-800 hover:bg-emerald-600 rounded-lg transition border border-slate-700">üö¥ Equipos</button>
        <button onclick="loadTable('glosario')" class="px-4 py-2 bg-slate-800 hover:bg-emerald-600 rounded-lg transition border border-slate-700">üß† Glosario</button>
    </div>

    <div id="content-area" class="glass rounded-xl p-6 min-h-[50vh]">
        <p class="text-slate-500 text-center mt-10">Selecciona una categor√≠a arriba para empezar a gestionar.</p>
    </div>

    <div id="editModal" class="fixed inset-0 bg-black/80 hidden flex justify-center items-center z-50">
        <div class="bg-slate-900 border border-slate-700 p-6 rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-xl font-bold text-white mb-4">Editar Elemento</h2>
            <form id="dynamicForm"></form> <div class="flex justify-end gap-3 mt-6">
                <button onclick="closeModal()" class="px-4 py-2 text-slate-400 hover:text-white">Cancelar</button>
                <button onclick="saveChanges()" class="px-6 py-2 bg-emerald-500 hover:bg-emerald-400 text-black font-bold rounded-lg">Guardar Cambios</button>
            </div>
        </div>
    </div>

    <script>
        // ESTADO GLOBAL
        let currentTable = '';
        let currentData = [];
        let editingId = null;

        // 1. CARGAR DATOS
        async function loadTable(table) {
            currentTable = table;
            document.getElementById('content-area').innerHTML = '<p class="text-center animate-pulse">Cargando datos...</p>';
            
            // Mapeo de nombres API (tu web usa nombres distintos en frontend y backend)
            let apiEndpoint = table;
            if(table === 'noticias') apiEndpoint = 'news';
            if(table === 'equipos') apiEndpoint = 'teams';
            if(table === 'calendario') apiEndpoint = 'calendar';
            if(table === 'glosario') apiEndpoint = 'glossary';

            try {
                const res = await fetch(`/api/${apiEndpoint}`);
                const data = await res.json();
                currentData = data;
                renderTable(data);
            } catch (e) {
                alert("Error cargando datos: " + e.message);
            }
        }

        // 2. DIBUJAR TABLA
        function renderTable(data) {
            if (!data || data.length === 0) {
                document.getElementById('content-area').innerHTML = '<p class="text-center text-slate-500">No hay datos en esta tabla.</p>';
                return;
            }

            // Detectar columnas autom√°ticamente (usamos las claves del primer objeto)
            const columns = Object.keys(data[0]).filter(k => k !== 'id' && k !== 'riders' && k !== 'details'); // Ocultamos columnas complejas en la vista r√°pida
            
            let html = `
                <div class="flex justify-between mb-4">
                    <h3 class="text-xl font-bold capitalize text-white">${currentTable}</h3>
                    <span class="text-xs text-slate-400 bg-slate-800 px-2 py-1 rounded">${data.length} registros</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left text-sm text-slate-300">
                        <thead class="bg-slate-800 text-emerald-400 uppercase font-bold text-xs">
                            <tr>
                                ${columns.map(c => `<th class="p-3">${c}</th>`).join('')}
                                <th class="p-3 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-slate-700">
            `;

            data.forEach(row => {
                html += `<tr class="hover:bg-slate-800/50 transition">`;
                columns.forEach(col => {
                    let val = row[col];
                    // Si es muy largo, lo cortamos
                    if (typeof val === 'string' && val.length > 50) val = val.substring(0, 50) + '...';
                    html += `<td class="p-3">${val || '-'}</td>`;
                });
                
                // Botones EDITAR y BORRAR conectados
                html += `
                    <td class="p-3 text-right flex justify-end gap-2">
                        <button onclick='openEditModal(${row.id})' class="bg-blue-600/20 text-blue-400 hover:bg-blue-600 hover:text-white px-3 py-1 rounded text-xs transition">EDITAR</button>
                        <button onclick='deleteItem(${row.id})' class="bg-red-600/20 text-red-400 hover:bg-red-600 hover:text-white px-3 py-1 rounded text-xs transition">BORRAR</button>
                    </td>
                </tr>`;
            });

            html += `</tbody></table></div>`;
            document.getElementById('content-area').innerHTML = html;
        }

        // 3. ABRIR MODAL Y GENERAR FORMULARIO (La Magia)
        function openEditModal(id) {
            editingId = id;
            const item = currentData.find(d => d.id === id);
            const form = document.getElementById('dynamicForm');
            form.innerHTML = ''; // Limpiar anterior

            // Recorremos todas las propiedades del objeto para crear inputs
            for (const [key, value] of Object.entries(item)) {
                if (key === 'id') continue; // El ID no se toca

                const label = document.createElement('label');
                label.className = "block text-xs uppercase text-slate-400 font-bold mb-1";
                label.innerText = key;

                let input;
                // Si es texto largo o JSON, usamos textarea
                if (key === 'content' || key === 'riders' || key === 'details' || key === 'profile' || key === 'definition') {
                    input = document.createElement('textarea');
                    input.rows = 6;
                    // Si es un objeto/array, lo convertimos a texto bonito
                    input.value = (typeof value === 'object') ? JSON.stringify(value, null, 2) : value;
                } else {
                    input = document.createElement('input');
                    input.type = "text";
                    input.value = value;
                }

                input.name = key;
                input.className = "w-full bg-slate-800 border border-slate-600 rounded p-2 text-white text-sm mb-4 focus:border-emerald-500 outline-none";

                form.appendChild(label);
                form.appendChild(input);
            }

            document.getElementById('editModal').classList.remove('hidden');
        }

        // 4. GUARDAR CAMBIOS (PUT al servidor)
        async function saveChanges() {
            const form = document.getElementById('dynamicForm');
            const formData = new FormData(form);
            const updateData = {};

            // Convertimos el formulario a objeto JSON
            for (let [key, value] of formData.entries()) {
                updateData[key] = value;
            }

            try {
                // Autenticaci√≥n b√°sica (admin:velo2026) en base64
                const authHeader = 'Basic ' + btoa('admin:velo2026');

                const res = await fetch(`/api/admin/${currentTable}/${editingId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': authHeader
                    },
                    body: JSON.stringify(updateData)
                });

                if (res.ok) {
                    closeModal();
                    loadTable(currentTable); // Recargar tabla para ver cambios
                    alert("‚úÖ Guardado correctamente");
                } else {
                    const err = await res.json();
                    alert("‚ùå Error al guardar: " + err.error);
                }
            } catch (e) {
                alert("Error de red: " + e.message);
            }
        }

        // 5. BORRAR ELEMENTO
        async function deleteItem(id) {
            if(!confirm("¬øSeguro que quieres borrar esto? No hay vuelta atr√°s.")) return;

            const authHeader = 'Basic ' + btoa('admin:velo2026');
            
            try {
                const res = await fetch(`/api/admin/${currentTable}/${id}`, {
                    method: 'DELETE',
                    headers: { 'Authorization': authHeader }
                });

                if(res.ok) {
                    loadTable(currentTable);
                } else {
                    alert("Error borrando");
                }
            } catch(e) { console.error(e); }
        }

        function closeModal() {
            document.getElementById('editModal').classList.add('hidden');
        }

        function logout() {
            // Truco simple para cerrar sesi√≥n en basic auth: redirigir con credenciales malas
            window.location.href = "https://logout:logout@" + window.location.host;
        }
    </script>
</body>
</html>
