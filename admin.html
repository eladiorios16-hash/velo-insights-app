<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VELO HUB | Admin Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="assets/main.css">
    <style>
        body { background-color: #050505; color: #e4e4e7; font-family: 'Inter', sans-serif; }
        .glass { background: rgba(20, 20, 20, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.08); }
        .tab-btn { padding: 1rem; width: 100%; text-align: left; display: flex; gap: 12px; font-weight: bold; border-radius: 0.5rem; transition: all 0.2s; align-items: center; color: #71717a; }
        .tab-btn:hover { background: #27272a; color: white; }
        .tab-btn.active { background: rgba(34, 211, 238, 0.1); color: #22d3ee; border: 1px solid rgba(34, 211, 238, 0.2); }
        .tab-content { display: none; animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        .input-dark { background: #09090b; border: 1px solid #27272a; color: white; padding: 0.75rem; border-radius: 0.5rem; width: 100%; outline: none; transition: 0.2s; font-size: 0.9rem; }
        .input-dark:focus { border-color: #22d3ee; }
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        .mode-badge { font-size: 9px; font-weight: 900; padding: 4px 8px; border-radius: 4px; text-transform: uppercase; background: #27272a; color: #a1a1aa; border: 1px solid #52525b; }
        .badge-edit { background: rgba(251, 191, 36, 0.1); color: #fbbf24; border-color: #fbbf24; }
    </style>
</head>

<body class="min-h-screen pb-20 bg-[#050505] text-zinc-200 font-sans">

    <nav class="border-b border-zinc-800 bg-black/80 sticky top-0 z-50 backdrop-blur-xl">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 rounded bg-cyan-600 flex items-center justify-center font-black text-black">V</div>
                <h1 class="text-sm font-bold tracking-widest text-zinc-400 uppercase">Command Center</h1>
            </div>
            <a href="/" target="_blank" class="text-xs font-bold text-zinc-400 border border-zinc-800 px-3 py-1 rounded hover:bg-zinc-800">Ver Web ‚Üó</a>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8 grid grid-cols-1 lg:grid-cols-4 gap-8">
        
        <aside class="lg:col-span-1 sticky top-20 z-40 h-fit">
            <div class="flex lg:flex-col gap-2 overflow-x-auto pb-4 lg:pb-0 custom-scrollbar">
                <button onclick="switchTab('news')" id="tab-news" class="tab-btn active"><span>üì∞</span> Noticias</button>
                <button onclick="switchTab('calendar')" id="tab-calendar" class="tab-btn"><span>üìÖ</span> Calendario</button>
                <button onclick="switchTab('teams')" id="tab-teams" class="tab-btn"><span>üö¥</span> Equipos</button>
                <button onclick="switchTab('ranking')" id="tab-ranking" class="tab-btn"><span>üèÜ</span> Ranking</button>
                <button onclick="switchTab('glossary')" id="tab-glossary" class="tab-btn"><span>üß†</span> Glosario</button>
                <div class="h-px bg-zinc-800 my-2"></div>
                <button onclick="switchTab('manager')" id="tab-manager" class="tab-btn text-cyan-500"><span>‚öôÔ∏è</span> Base de Datos</button>
            </div>
        </aside>

        <div class="lg:col-span-3 pb-20">
            
            <section id="news" class="tab-content active glass rounded-2xl p-6">
                <div class="flex justify-between mb-6"><h2 class="text-2xl font-black uppercase text-white">Noticias</h2><button onclick="clearForms()" class="text-xs font-bold text-zinc-500">LIMPIAR</button></div>
                <form id="form-news" class="space-y-4" onsubmit="event.preventDefault(); saveData('noticias')">
                    <input type="hidden" id="news-id">
                    <div id="status-news" class="mode-badge w-fit">NUEVO</div>
                    <input type="text" id="news-title" placeholder="Titular" class="input-dark text-lg font-bold">
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="news-date" placeholder="Fecha (16 FEB)" class="input-dark">
                        <input type="text" id="news-tag" placeholder="Tag (RACE REPORT)" class="input-dark">
                    </div>
                    <input type="text" id="news-image" placeholder="URL Imagen" class="input-dark">
                    <div class="flex gap-2 items-center"><input type="checkbox" id="news-hero"><label class="text-xs uppercase font-bold">Destacar (Hero)</label></div>
                    <textarea id="news-lead" placeholder="Resumen..." class="input-dark h-20"></textarea>
                    <textarea id="news-content" placeholder="HTML Completo (Opcional)" class="input-dark h-32 font-mono text-xs"></textarea>
                    <button type="submit" class="w-full py-3 bg-white text-black font-black uppercase rounded hover:bg-cyan-400">Publicar</button>
                </form>
            </section>

            <section id="teams" class="tab-content glass rounded-2xl p-6">
                <div class="flex justify-between mb-6"><h2 class="text-2xl font-black uppercase text-blue-500">Equipos</h2><button onclick="clearForms()" class="text-xs font-bold text-zinc-500">LIMPIAR</button></div>
                <form id="form-teams" class="space-y-4" onsubmit="event.preventDefault(); saveData('teams')">
                    <input type="hidden" id="team-id">
                    <div id="status-teams" class="mode-badge w-fit">NUEVO EQUIPO</div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="team-name" placeholder="Nombre (Ej: Visma)" class="input-dark font-bold">
                        <input type="text" id="team-code" placeholder="C√≥digo (TVL)" class="input-dark font-mono text-center">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="team-country" placeholder="Pa√≠s (üá≥üá±)" class="input-dark text-center">
                        <input type="text" id="team-jersey" placeholder="URL Maillot" class="input-dark text-xs">
                    </div>

                    <div class="bg-black/40 p-4 rounded border border-zinc-800">
                        <h3 class="text-xs font-black uppercase mb-2">Ciclistas (JSON)</h3>
                        <p class="text-[9px] text-zinc-500 mb-2">Formato: [{"name":"Pogacar", "type":"GC", "country":"üá∏üáÆ", "stats":{"ovr":99, "mnt":99, "spr":85}}]</p>
                        <textarea id="team-riders" class="input-dark h-40 font-mono text-[10px] text-green-400" placeholder="[]"></textarea>
                    </div>

                    <button type="submit" class="w-full py-3 bg-blue-600 text-white font-black uppercase rounded hover:bg-blue-500">Guardar Equipo</button>
                </form>
            </section>

            <section id="calendar" class="tab-content glass rounded-2xl p-6">
                <div class="flex justify-between mb-6"><h2 class="text-2xl font-black uppercase text-yellow-500">Calendario</h2><button onclick="clearForms()" class="text-xs font-bold text-zinc-500">LIMPIAR</button></div>
                <form id="form-calendar" class="space-y-4" onsubmit="event.preventDefault(); saveData('calendario')">
                    <input type="hidden" id="race-id">
                    <div id="status-calendar" class="mode-badge w-fit">NUEVA CARRERA</div>
                    <input type="text" id="race-name" placeholder="Nombre Carrera" class="input-dark font-bold">
                    <div class="grid grid-cols-3 gap-4">
                        <select id="race-status" class="input-dark"><option value="Upcoming">Pendiente</option><option value="Active">En Curso</option><option value="Finished">Finalizada</option></select>
                        <input type="text" id="race-date" placeholder="Fecha Texto" class="input-dark">
                        <input type="date" id="race-iso" class="input-dark">
                    </div>
                    <input type="text" id="race-cat" placeholder="Categor√≠a (WT)" class="input-dark">
                    
                    <div class="bg-black/40 p-4 rounded border border-zinc-800">
                        <h3 class="text-xs font-black uppercase mb-2">Etapas y Detalles (JSON)</h3>
                        <textarea id="race-details" class="input-dark h-32 font-mono text-[10px]" placeholder='{"stages": [], "winner": ""}'></textarea>
                    </div>
                    <button type="submit" class="w-full py-3 bg-yellow-500 text-black font-black uppercase rounded hover:bg-yellow-400">Guardar Carrera</button>
                </form>
            </section>

            <section id="ranking" class="tab-content glass rounded-2xl p-6">
                <div class="flex justify-between mb-6"><h2 class="text-2xl font-black uppercase text-emerald-500">Ranking</h2><button onclick="clearForms()" class="text-xs font-bold text-zinc-500">LIMPIAR</button></div>
                <form id="form-ranking" class="space-y-4" onsubmit="event.preventDefault(); saveData('ranking')">
                    <input type="hidden" id="rank-id">
                    <div id="status-ranking" class="mode-badge w-fit">NUEVO</div>
                    <div class="grid grid-cols-4 gap-4">
                        <input type="text" id="rank-name" placeholder="Ciclista" class="input-dark font-bold col-span-3">
                        <input type="number" id="rank-pos" placeholder="#" class="input-dark text-center">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="rank-team" placeholder="Equipo" class="input-dark">
                        <input type="number" id="rank-points" placeholder="Puntos" class="input-dark text-right">
                    </div>
                    <input type="text" id="rank-profile" placeholder='JSON Perfil: {"img":"...", "role":"GC"}' class="input-dark font-mono text-xs">
                    <button type="submit" class="w-full py-3 bg-emerald-500 text-black font-black uppercase rounded hover:bg-emerald-400">Actualizar Ranking</button>
                </form>
            </section>

            <section id="glossary" class="tab-content glass rounded-2xl p-6">
                <div class="flex justify-between mb-6"><h2 class="text-2xl font-black uppercase text-purple-500">Glosario</h2><button onclick="clearForms()" class="text-xs font-bold text-zinc-500">LIMPIAR</button></div>
                <form id="form-glossary" class="space-y-4" onsubmit="event.preventDefault(); saveData('glosario')">
                    <input type="hidden" id="gloss-id">
                    <div id="status-glossary" class="mode-badge w-fit">NUEVO</div>
                    <div class="grid grid-cols-2 gap-4">
                        <input type="text" id="gloss-term" placeholder="T√©rmino" class="input-dark font-bold">
                        <input type="text" id="gloss-cat" placeholder="Categor√≠a" class="input-dark">
                    </div>
                    <textarea id="gloss-def" placeholder="Definici√≥n..." class="input-dark h-24"></textarea>
                    <button type="submit" class="w-full py-3 bg-purple-500 text-white font-black uppercase rounded hover:bg-purple-400">Guardar</button>
                </form>
            </section>

            <section id="manager" class="tab-content glass rounded-2xl p-6">
                <div class="flex justify-between mb-6">
                    <h2 class="text-xl font-bold uppercase">Gestor DB</h2>
                    <select id="manager-filter" onchange="loadFromAPI(this.value)" class="bg-black border border-zinc-800 rounded px-2 text-xs uppercase font-bold">
                        <option value="noticias">Noticias</option>
                        <option value="teams">Equipos</option>
                        <option value="calendario">Calendario</option>
                        <option value="ranking">Ranking</option>
                        <option value="glosario">Glosario</option>
                    </select>
                </div>
                <div id="manager-list" class="space-y-2 max-h-96 overflow-y-auto custom-scrollbar"></div>
            </section>

        </div>
    </main>

    <script>
        // Mapeo Frontend -> API
        const ENDPOINTS = {
            'noticias': 'news',
            'teams': 'teams',
            'calendario': 'calendar',
            'ranking': 'ranking',
            'glosario': 'glossary'
        };

        // --- GUARDAR ---
        async function saveData(type) {
            const api = ENDPOINTS[type];
            const id = document.getElementById(type === 'teams' ? 'team-id' : type === 'noticias' ? 'news-id' : type === 'calendario' ? 'race-id' : type === 'ranking' ? 'rank-id' : 'gloss-id').value;
            let body = {};

            if(type === 'noticias') {
                body = {
                    title: document.getElementById('news-title').value,
                    date: document.getElementById('news-date').value,
                    tag: document.getElementById('news-tag').value,
                    image: document.getElementById('news-image').value,
                    lead: document.getElementById('news-lead').value,
                    content: document.getElementById('news-content').value,
                    isHero: document.getElementById('news-hero').checked
                };
            } else if(type === 'teams') {
                body = {
                    name: document.getElementById('team-name').value,
                    code: document.getElementById('team-code').value,
                    country: document.getElementById('team-country').value,
                    jersey: document.getElementById('team-jersey').value,
                    riders: JSON.parse(document.getElementById('team-riders').value || '[]')
                };
            } else if(type === 'calendario') {
                body = {
                    name: document.getElementById('race-name').value,
                    status: document.getElementById('race-status').value,
                    date: document.getElementById('race-date').value,
                    dateISO: document.getElementById('race-iso').value,
                    category: document.getElementById('race-cat').value,
                    details: document.getElementById('race-details').value // Se env√≠a como string JSON
                };
            } else if(type === 'ranking') {
                body = {
                    rank: document.getElementById('rank-pos').value,
                    name: document.getElementById('rank-name').value,
                    team: document.getElementById('rank-team').value,
                    points: document.getElementById('rank-points').value,
                    profile: document.getElementById('rank-profile').value // JSON String
                };
            } else if(type === 'glosario') {
                body = { term: document.getElementById('gloss-term').value, cat: document.getElementById('gloss-cat').value, definition: document.getElementById('gloss-def').value };
            }

            const method = id ? 'PUT' : 'POST';
            const url = id ? `/api/admin/${api}/${id}` : `/api/admin/${api}`;

            try {
                const res = await fetch(url, { method, headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
                if(res.ok) { alert('Guardado OK'); if(!id) clearForms(); if(document.getElementById('manager').style.display === 'block') loadFromAPI(type); }
                else { alert('Error: ' + await res.text()); }
            } catch(e) { alert('Error conexi√≥n'); }
        }

        // --- CARGAR DATOS ---
        async function loadFromAPI(type) {
            const api = ENDPOINTS[type];
            const list = document.getElementById('manager-list');
            list.innerHTML = 'Cargando...';
            const res = await fetch(`/api/${api}`);
            const data = await res.json();
            list.innerHTML = data.map(item => {
                const safe = JSON.stringify(item).replace(/"/g, '&quot;');
                return `<div class="flex justify-between p-2 bg-zinc-900 border border-zinc-800 mb-1 rounded">
                    <span class="text-xs font-bold truncate w-2/3">${item.name || item.title || item.term}</span>
                    <div class="flex gap-2"><button onclick="loadItem('${type}', ${safe})" class="text-cyan-500 text-[10px] uppercase font-bold">Editar</button>
                    <button onclick="deleteItem('${type}', ${item.id})" class="text-red-500 text-[10px] uppercase font-bold">Borrar</button></div>
                </div>`;
            }).join('');
        }

        function loadItem(type, item) {
            switchTab(type);
            document.getElementById(`status-${type}`).innerText = `EDITANDO ID: ${item.id}`;
            document.getElementById(`status-${type}`).classList.add('badge-edit');

            if(type === 'teams') {
                document.getElementById('team-id').value = item.id;
                document.getElementById('team-name').value = item.name;
                document.getElementById('team-code').value = item.code;
                document.getElementById('team-country').value = item.country;
                document.getElementById('team-jersey').value = item.jersey;
                // riders puede venir como objeto o string, aseguramos string bonita
                document.getElementById('team-riders').value = typeof item.riders === 'string' ? item.riders : JSON.stringify(item.riders, null, 2);
            } 
            // ... (resto de cargas similares a la versi√≥n anterior) ...
            else if(type === 'noticias') {
                document.getElementById('news-id').value = item.id;
                document.getElementById('news-title').value = item.title;
                document.getElementById('news-lead').value = item.lead;
                document.getElementById('news-content').value = item.content || '';
                document.getElementById('news-image').value = item.image;
                document.getElementById('news-date').value = item.date;
                document.getElementById('news-tag').value = item.tag;
            } else if(type === 'calendario') {
                document.getElementById('race-id').value = item.id;
                document.getElementById('race-name').value = item.name;
                document.getElementById('race-details').value = typeof item.details === 'string' ? item.details : JSON.stringify(item.details, null, 2);
                document.getElementById('race-status').value = item.status;
                document.getElementById('race-iso').value = item.dateISO;
            }
        }

        async function deleteItem(type, id) {
            if(!confirm('¬øBorrar?')) return;
            const api = ENDPOINTS[type];
            await fetch(`/api/admin/${api}/${id}`, { method: 'DELETE' });
            loadFromAPI(type);
        }

        function switchTab(id) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.querySelectorAll('.tab-btn').forEach(e => e.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById(`tab-${id}`).classList.add('active');
            if(id === 'manager') loadFromAPI(document.getElementById('manager-filter').value);
        }

        function clearForms() {
            document.querySelectorAll('form').forEach(f => f.reset());
            document.querySelectorAll('input[type=hidden]').forEach(i => i.value='');
            document.querySelectorAll('.mode-badge').forEach(b => { b.innerText = 'NUEVO'; b.classList.remove('badge-edit'); });
        }
    </script>
</body>
</html>
